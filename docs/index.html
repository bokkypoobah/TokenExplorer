<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Token Explorer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta name="description" content="Token Explorer (c) Bok Consulting Pty Ltd 2023" /4
    <meta name="author" content="BokkyPooBah" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@BokkyPooBah" />
    <meta name="twitter:creator" content="@BokkyPooBah" />
    <link type="text/css" rel="stylesheet" href="css/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="css/bootstrap-vue.min.css"/>
    <link type="text/css" rel="stylesheet" href="css/bootstrap-vue-icons.min.css"/>
    <link type="text/css" rel="stylesheet" href="css/app.css" />
    <script src="js/vue.js"></script>
    <script src="js/bootstrap-vue.min.js"></script>
    <script src="js/bootstrap-vue-icons.min.js"></script>
    <script src="js/ethers-5.7.umd.min.js" type="application/javascript"></script>
    <script src="js/moment.min.js"></script>
    <script src="globals.js"></script>
    <script src="customNames.js"></script>
    <script src="deploymentData.js"></script>
    <script src="networks.js"></script>
    <script src="parseEventLogs.js"></script>

    <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
    <link rel="manifest" href="images/site.webmanifest">
    <link rel="mask-icon" href="images/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="images/favicon.ico">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="images/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
  </head>
  <body>
    <div id="app">
      <b-container fluid class="m-0 p-0">
        <b-navbar toggleable="sm" variant="light" class="mx-1 my-0 p-0">
          <b-navbar-brand to="https://bokkypoobah.github.io/TokenExplorer/" variant="primary">
            <b-avatar rounded variant="light" size="3.0rem" src="images/ZombieBaby_004_transparentbg_zoomed.png" v-b-popover.hover.ds500="'gm'" class="ml-0"></b-avatar>
            <em v-b-popover.hover.ds500="'gm gm gm'">Token Explorer</em>
          </b-navbar-brand>
          <b-navbar-nav class="ml-auto">
            <b-nav-item size="sm" @click="settings.tabIndex = 0; saveSettings();" :active="settings.tabIndex == 0" active-class="active" v-b-popover.hover.ds500="'Home, and information on this tool'">Home</b-nav-item>
            <b-nav-item size="sm" @click="settings.tabIndex = 1; saveSettings();" :active="settings.tabIndex == 1" active-class="active" v-b-popover.hover.ds500="'ERC-20, ERC-721 and ERC-1155 token contract explorer'">Explorer</b-nav-item>
            <!-- <b-nav-item size="sm" @click="settings.tabIndex = 2; saveSettings();" :active="settings.tabIndex == 2" active-class="active" v-b-popover.hover.ds500="'ERC-20 functions to be migrated'">To Do</b-nav-item> -->
            <!-- <b-nav-item size="sm" @click="settings.tabIndex = 3; saveSettings();" :active="settings.tabIndex == 3" active-class="active" v-b-popover.hover.ds500="'ERC-721 Non-Fungible Tokens'">ERC-721</b-nav-item> -->
            <!-- <b-nav-item size="sm" @click="settings.tabIndex = 4; saveSettings();" :active="settings.tabIndex == 4" active-class="active" v-b-popover.hover.ds500="'ERC-1155 Non-Fungible Tokens - WIP'">ERC-1155</b-nav-item> -->
            <b-button size="sm" variant="outline-primary" class="ml-1" @click="connectToWeb3(); processNewBlock(0);" v-b-popover.hover.ds500="'Click to update wallet'">{{ coinbase && (coinbase.substring(0, 8) + '...' + coinbase.slice(-6)) || 'Connect' }}</b-button>
          </b-navbar-nav>
        </b-navbar>

        <b-card no-body class="p-0 mt-0" style="min-height: 666px;">
          <b-alert v-if="false && chainId && chainId != 11155111" size="sm" dismissible variant="warning" show class="m-1 my-0">
            Warning: This dapp is for use on the Ethereum Sepolia testnet
          </b-alert>
          <b-card class="m-2 p-1" header-class="warningheader" header="Welcome" v-if="!coinbase">
            <b-card-text>
              Please install the MetaMask extension and connect to the Ethereum Mainnet or an EVM compatible chain. Then refresh this page, and click the [Connect] button on the top right.
            </b-card-text>
          </b-card>

          <b-card class="m-0 p-0 border-0" body-class="m-1 p-0">

            <b-modal ref="nonfungiblemodal" v-model="modalNonFungible.show" hide-footer header-class="m-0 px-3 py-2" body-bg-variant="light" size="lg">
              <template #modal-title>{{ "ERC-" + modalNonFungible.type + ' Non-Fungible Token' }}</template>

              <b-form-group label="contract:" label-for="nonfungiblemodal-contract" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <b-input-group size="sm" class="w-100">
                  <b-form-input type="text" readonly size="sm" id="nonfungiblemodal-contract" v-model="modalNonFungible.contract"></b-form-input>
                  <b-input-group-append>
                    <b-button size="sm" :href="explorer + 'token/' + modalNonFungible.contract + '#code'" variant="link" v-b-popover.hover.ds500="'View in explorer'" target="_blank" class="m-0 ml-1 p-0"><b-icon-link45deg shift-v="+1" font-scale="0.95"></b-icon-link45deg></b-button>
                  </b-input-group-append>
                </b-input-group>
              </b-form-group>

              <b-form-group label="tokenId:" label-for="nonfungiblemodal-tokenid" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <b-input-group size="sm" class="w-100">
                  <b-form-input type="text" readonly size="sm" id="nonfungiblemodal-tokenid" v-model="modalNonFungible.tokenId"></b-form-input>
                  <b-input-group-append>
                    <b-button size="sm" :href="nonFungibleViewerURL(modalNonFungible.contract, modalNonFungible.tokenId)" variant="link" v-b-popover.hover.ds500="'View in NFT viewer'" target="_blank" class="m-0 ml-1 p-0"><b-icon-link45deg shift-v="+1" font-scale="0.95"></b-icon-link45deg></b-button>
                  </b-input-group-append>
                </b-input-group>
              </b-form-group>
              <font size="-1">
                <b-table small fixed striped :items="modalNonFungible.logs" show-empty head-variant="light" class="mt-1">
                  <template #cell(log)="data">
                    <font size="-2" style="overflow-wrap: break-word;">{{ data.item.log }}</font>
                  </template>
                </b-table>
              </font>

              name: {{ modalNonFungible.name }}
              description: {{ modalNonFungible.description }}
              image: {{ modalNonFungible.image }}
              attributes: {{ modalNonFungible.attributes }}
            </b-modal>

            <!-- HOME: -->
            <b-card v-if="settings.tabIndex == 0" header="Home" no-body class="m-0 p-0">
              <b-card-body class="mt-1 p-1">
                <h5>Welcome</h5>
                This app is an explorer for <b-link href="https://eips.ethereum.org/EIPS/eip-20" target="_blank">ERC-20</b-link> Fungible, and <b-link href="https://eips.ethereum.org/EIPS/eip-721" target="_blank">ERC-721</b-link> and <b-link href="https://eips.ethereum.org/EIPS/eip-1155" target="_blank">ERC-1155</b-link> Non-Fungible tokens.
                <br />
                <h6 class="mt-4">How This Works</h6>
                <ul>
                  <li>Enter a token contact address, or select from one of the samples token contracts from the dropdown list</li>
                  <li>This app then scans for event logs using the <b-link href="https://docs.ethers.org/v5/api/providers/provider/#Provider-getLogs" target="_blank">getLogs(filter)</b-link> web3 call</li>
                  <li>These event logs are then processed for presentation in this app</li>
                </ul>
                <h6 class="mt-4">Requirements</h6>
                <ul>
                  <li>Web3 enabled desktop browser, connected to an Ethereum-Virtual-Machine compatible chain</li>
                  <li>Use one of these web3 browser plug-ins if necessary: MetaMask @ <b-link href="https://metamask.io/" target="_blank">https://metamask.io/</b-link>, or Rabby @ <b-link href="https://rabby.io/" target="_blank">https://rabby.io/</b-link></li>
                </ul>
                <h6 class="mt-4">References</h6>
                <ul>
                  <li>App UI: <b-link href="https://bokkypoobah.github.io/TokenExplorer/" target="_blank">https://bokkypoobah.github.io/TokenExplorer/</b-link></li>
                  <li>GitHub: <b-link href="https://github.com/bokkypoobah/TokenExplorer" target="_blank">https://github.com/bokkypoobah/TokenExplorer</b-link></li>
                  <li>Main app source code: <b-link href="https://github.com/bokkypoobah/TokenExplorer/blob/main/docs/index.html" target="_blank">https://github.com/bokkypoobah/TokenExplorer/blob/main/docs/index.html</b-link></li>
                </ul>
                <h6 class="mt-4">Running Locally</h6>
                <ul>
                  <li>In a folder on your computer, <b>git clone <b-link href="https://github.com/bokkypoobah/TokenExplorer" target="_blank">https://github.com/bokkypoobah/TokenExplorer</b-link></b></li>
                  <li>Run a tool like <b-link href="https://www.npmjs.com/package/anywhere" target="_blank">anywhere</b-link> in the <b>./docs</b> subdirectory of the folder created above</li>
                </ul>
                <h6 class="mt-4">Troubleshooting</h6>
                <ul>
                  <li>If this dapp is not receiving the latest Mainnet data, reset your MetaMask web3 connection using <b>Settings</b> -> <b>Advanced</b> -> <b>Clear activity and nonce data</b></li>
                  <li>Reset this dapp data by removing LocalStorage entries with the keys beginning with <b>approval</b></li>
                </ul>
              </b-card-body>
            </b-card>

            <!-- Explorer: -->
            <b-card v-if="settings.tabIndex == 1" no-header body-class="m-0 p-0" class="m-0 p-0 border-0">
              <b-tabs card v-model="settings.tableIndex" @changed="saveSettings();" content-class="mt-2" align="left">
                <template #tabs-start>

                  <div class="d-flex flex-wrap m-0 p-0">
                    <div class="mt-0 pr-0" style="width: 25.0rem;">
                      <b-form-input type="text" size="sm" id="explorer-contract" v-model="settings.contract" @change="saveSettings" placeholder="Enter token contract address, or select from dropdown"></b-form-input>
                    </div>
                    <div class="mt-0 pr-1">
                      <b-dropdown size="sm" id="dropdown-left" text="" variant="link" v-b-popover.hover.ds500="'Some sample token contracts'" class="m-0 ml-1 p-0">
                        <b-dropdown-item v-if="sampleContracts('all').length == 0" disabled>No sample contracts on this network</b-dropdown-item>
                        <div v-for="(item, index) of sampleContracts('all')" v-bind:key="index">
                          <b-dropdown-item @click="settings.contract = item.contract; saveSettings();">{{ index }}. {{ 'ERC-' + item.type }} {{ item.contract.substring(0, 8) + '...' + item.contract.slice(-6) + ' ' + item.name }}</b-dropdown-item>
                        </div>
                      </b-dropdown>
                    </div>
                    <div class="mt-0 pr-1">
                      <b-button size="sm" :disabled="!validAddress(settings.contract)" @click="retrieveEvents" variant="primary">Retrieve</b-button>
                    </div>
                    <!-- <div class="mt-0 pr-1">
                      <b-button :disabled="!settings.contract || !validAddress(settings.contract)" @click="copyToClipboard(settings.contract);" variant="link" v-b-popover.hover.ds500="'Copy ERC-20 contract address to clipboard'" class="m-0 ml-2 p-0"><b-icon-clipboard shift-v="+1" font-scale="1.1"></b-icon-clipboard></b-button>
                    </div> -->
                    <div class="mt-0 pr-1">
                      <b-button size="sm" :disabled="!validAddress(settings.contract)" :href="explorer + 'token/' + settings.contract + '#code'" variant="link" v-b-popover.hover.ds500="'View in explorer'" target="_blank" class="m-0 ml-2 mr-2 p-0"><b-icon-link45deg shift-v="-1" font-scale="1.2"></b-icon-link45deg></b-button>
                    </div>
                    <div class="mt-0 pr-1" style="width: 20.0rem;">
                      <b-badge pill variant="light" v-b-popover.hover.ds500="decimals != null && totalSupply && ('symbol: ' + symbol + ', name: ' + name + ', decimals: ' + decimals + ', totalSupply: ' + formatDecimals(totalSupply, decimals) + ' (' + formatDecimals(totalSupply, 0) + ')') || ''" class="mt-2 ml-2 mr-4">
                        {{ (type && ('ERC-' + type) || '') + ((symbol && (': ' + symbol)) || '') }}
                      </b-badge>
                    </div>
                    <!-- <div class="mt-0 flex-grow-1">
                    </div> -->
                  </div>
                </template>
                <b-tab no-body active>
                  <template #title>
                    <span v-b-popover.hover.ds500="'Token Transfer, Approval and ApprovalForAll events'">Events</span>
                  </template>
                </b-tab>
                <b-tab no-body>
                  <template #title>
                    <span v-b-popover.hover.ds500="'ERC-20 token balances, ERC-721 and ERC-1155 tokens'">Tokens</span>
                  </template>
                </b-tab>
                <b-tab no-body>
                  <template #title>
                    <span v-b-popover.hover.ds500="'ERC-20 and ERC-721 Approvals state'">Approvals</span>
                  </template>
                </b-tab>
                <b-tab no-body>
                  <template #title>
                    <span v-b-popover.hover.ds500="'ERC-721 and ERC-1155 ApprovalForAll state'">ApprovalForAll</span>
                  </template>
                </b-tab>
              </b-tabs>

              <div class="d-flex flex-wrap m-0 p-0">
                <div class="mt-0 pr-1" style="width: 11.0rem;">
                  <b-form-input type="text" size="sm" v-model.trim="settings.filter" @change="saveSettings" debounce="600" placeholder="🔍 address regex"></b-form-input>
                </div>
                <div v-if="type == 721 || type == 1155" class="mt-0 pr-1" style="width: 11.0rem;">
                  <b-form-input type="text" size="sm" v-model.trim="settings.tokenIdFilter" @change="saveSettings" debounce="600" placeholder="🔍 tokenid regex"></b-form-input>
                </div>
                <div class="mt-0 pr-1" style="width: 11.0rem;">
                  <b-form-input type="text" size="sm" v-model.trim="settings.blockTxHashFilter" @change="saveSettings" debounce="600" placeholder="🔍 block/txhash regex"></b-form-input>
                </div>
                <div class="mt-0 flex-grow-1">
                </div>
                <div class="mt-0 pr-1">
                  <div v-if="settings.tableIndex == 0">
                    <b-button size="sm" @click="retrieveTimestamps(pagedSortedFilteredEvents.map(e => e.blockNumber))" variant="link" v-b-popover.hover.ds500="'Retrieve timestamps for events below'"><b-icon-clock-history shift-v="+1" font-scale="1.2"></b-icon-clock-history></b-button>
                  </div>
                  <div v-else-if="settings.tableIndex == 1">
                    <b-button size="sm" @click="retrieveTimestamps(pagedSortedFilteredTokens.map(e => e.blockNumber))" variant="link" v-b-popover.hover.ds500="'Retrieve timestamps for tokens below'"><b-icon-clock-history shift-v="+1" font-scale="1.2"></b-icon-clock-history></b-button>
                  </div>
                  <div v-else-if="settings.tableIndex == 2">
                    <b-button size="sm" @click="retrieveTimestamps(pagedSortedFilteredApprovals.map(e => e.blockNumber))" variant="link" v-b-popover.hover.ds500="'Retrieve timestamps for approvals'"><b-icon-clock-history shift-v="+1" font-scale="1.2"></b-icon-clock-history></b-button>
                  </div>
                  <div v-else-if="settings.tableIndex == 3">
                    <b-button size="sm" @click="retrieveTimestamps(pagedSortedFilteredApprovalForAlls.map(e => e.blockNumber))" variant="link" v-b-popover.hover.ds500="'Retrieve timestamps for allowances below'"><b-icon-clock-history shift-v="+1" font-scale="1.2"></b-icon-clock-history></b-button>
                  </div>
                </div>
                <div class="mt-0 flex-grow-1">
                </div>
                <div class="mt-0 pl-1">
                  <div v-if="settings.tableIndex == 0">
                    <b-form-select size="sm" v-model="settings.eventsTable.sortOption" @change="saveSettings" :options="eventsSortOptions" v-b-popover.hover.bottom="'Yeah. Sort'"></b-form-select>
                  </div>
                  <div v-else-if="settings.tableIndex == 1">
                    <div v-if="type != 721 && type != 1155">
                      <b-form-select size="sm" v-model="settings.tokensTable.sortOptionERC20" @change="saveSettings" :options="erc20TokensSortOptions" v-b-popover.hover.bottom="'Yeah. Sort'"></b-form-select>
                    </div>
                    <div v-if="type == 721">
                      <b-form-select size="sm" v-model="settings.tokensTable.sortOptionERC721" @change="saveSettings" :options="erc721And1155TokensSortOptions" v-b-popover.hover.bottom="'Yeah. Sort'"></b-form-select>
                    </div>
                    <div v-if="type == 1155">
                      <b-form-select size="sm" v-model="settings.tokensTable.sortOptionERC1155" @change="saveSettings" :options="erc721And1155TokensSortOptions" v-b-popover.hover.bottom="'Yeah. Sort'"></b-form-select>
                    </div>
                  </div>
                  <div v-else-if="settings.tableIndex == 2">
                    <b-form-select size="sm" v-model="settings.approvalsTable.sortOption" @change="saveSettings" :options="approvalsSortOptions" v-b-popover.hover.bottom="'Yeah. Sort'"></b-form-select>
                  </div>
                  <div v-else-if="settings.tableIndex == 3">
                    <b-form-select size="sm" v-model="settings.approvalForAllsTable.sortOption" @change="saveSettings" :options="erc721And1155ApprovalForAllsSortOptions" v-b-popover.hover.bottom="'Yeah. Sort'"></b-form-select>
                  </div>
                </div>
                <div class="mt-0 pl-1">
                  <div v-if="settings.tableIndex == 0">
                    <font size="-2" v-b-popover.hover.bottom="'# filtered / total events'">{{ formatNumber(sortedFilteredEvents.length) + '/' + formatNumber(events.length) }}</font>
                  </div>
                  <div v-else-if="settings.tableIndex == 1">
                    <font size="-2" v-b-popover.hover.bottom="'# filtered / total tokens'">{{ formatNumber(sortedFilteredTokens.length) + '/' + formatNumber(tokens.length) }}</font>
                  </div>
                  <div v-else-if="settings.tableIndex == 2">
                    <font size="-2" v-b-popover.hover.bottom="'# filtered / total approvals'">{{ formatNumber(sortedFilteredApprovals.length) + '/' + formatNumber(approvals.length) }}</font>
                  </div>
                  <div v-else-if="settings.tableIndex == 3">
                    <font size="-2" v-b-popover.hover.bottom="'# filtered / total approvalForAlls'">{{ formatNumber(sortedFilteredApprovalForAlls.length) + '/' + formatNumber(approvalForAlls.length) }}</font>
                  </div>
                </div>
                <div class="mt-0 pl-1">
                  <div v-if="settings.tableIndex == 0">
                    <b-pagination size="sm" v-model="settings.eventsTable.currentPage" @input="saveSettings" :total-rows="sortedFilteredEvents.length" :per-page="settings.eventsTable.pageSize" style="height: 0;"></b-pagination>
                  </div>
                  <div v-else-if="settings.tableIndex == 1">
                    <b-pagination size="sm" v-model="settings.tokensTable.currentPage" @input="saveSettings" :total-rows="sortedFilteredTokens.length" :per-page="settings.tokensTable.pageSize" style="height: 0;"></b-pagination>
                  </div>
                  <div v-else-if="settings.tableIndex == 2">
                    <b-pagination size="sm" v-model="settings.approvalsTable.currentPage" @input="saveSettings" :total-rows="sortedFilteredApprovals.length" :per-page="settings.approvalsTable.pageSize" style="height: 0;"></b-pagination>
                  </div>
                  <div v-else-if="settings.tableIndex == 3">
                    <b-pagination size="sm" v-model="settings.approvalForAllsTable.currentPage" @input="saveSettings" :total-rows="sortedFilteredApprovalForAlls.length" :per-page="settings.approvalForAllsTable.pageSize" style="height: 0;"></b-pagination>
                  </div>
                </div>
                <div class="mt-0 pl-1">
                  <div v-if="settings.tableIndex == 0">
                    <b-form-select size="sm" v-model="settings.eventsTable.pageSize" @change="saveSettings();" :options="pageSizes" v-b-popover.hover.bottom="'Yeah. Page size'"></b-form-select>
                  </div>
                  <div v-else-if="settings.tableIndex == 1">
                    <b-form-select size="sm" v-model="settings.tokensTable.pageSize" @change="saveSettings();" :options="pageSizes" v-b-popover.hover.bottom="'Yeah. Page size'"></b-form-select>
                  </div>
                  <div v-else-if="settings.tableIndex == 2">
                    <b-form-select size="sm" v-model="settings.approvalsTable.pageSize" @change="saveSettings();" :options="pageSizes" v-b-popover.hover.bottom="'Yeah. Page size'"></b-form-select>
                  </div>
                  <div v-else-if="settings.tableIndex == 3">
                    <b-form-select size="sm" v-model="settings.approvalForAllsTable.pageSize" @change="saveSettings();" :options="pageSizes" v-b-popover.hover.bottom="'Yeah. Page size'"></b-form-select>
                  </div>
                </div>
              </div>

              <!-- Events: -->
              <div v-if="settings.tableIndex == 0">
                <b-table small fixed striped :fields="eventsFields" :items="pagedSortedFilteredEvents" show-empty empty-html="Click [Retrieve] above" head-variant="light" class="mt-1">
                  <template #cell(number)="data">
                      <font size="-1" class="text-muted">{{ parseInt(data.index) + ((settings.eventsTable.currentPage - 1) * settings.eventsTable.pageSize) + 1 }}</font>
                  </template>
                  <template #cell(when)="data">
                    <font size="-1">
                      <b-link size="sm" :href="explorer + 'tx/' + data.item.txHash + '#eventlog#' + data.item.logIndex" variant="link" v-b-popover.hover.ds500="(timestamps[chainId] && timestamps[chainId][data.item.blockNumber]) ? ('Block ' + formatNumber(data.item.blockNumber)) : 'blockNumber:txIndex'" target="_blank">
                        <span v-if="timestamps[chainId] && timestamps[chainId][data.item.blockNumber]">
                          {{ formatTimestamp(timestamps[chainId][data.item.blockNumber]) }}
                        </span>
                        <span v-else>
                          {{ data.item.blockNumber + ':' + data.item.txIndex }}
                        </span>
                      </b-link>
                      <font size="-1" v-b-popover.hover.ds500="'logIndex'" class="text-muted">{{ data.item.logIndex }}</font>
                      <font size="-1" v-b-popover.hover.ds500="'txHash'" class="text-muted">{{ data.item.txHash.substring(0, 8) + '...' + data.item.txHash.slice(-6) }}</font>
                    </font>
                  </template>
                  <template #cell(type)="data">
                    <font size="-1">{{ data.item.type }}</font>
                  </template>
                  <template #cell(fromOwner)="data">
                    <div v-if="data.item.type == 'Transfer' || data.item.type == 'TransferSingle' || data.item.type == 'TransferBatch'">
                      <b-link size="sm" :href="explorer + 'address/' + data.item.from" variant="link" v-b-popover.hover.ds500="'Transfer from ' + data.item.from" target="_blank">
                        {{ data.item.from.substring(0, 8) + '...' + data.item.from.slice(-6) }}
                      </b-link>
                    </div>
                    <div v-else-if="data.item.type == 'Approval'">
                      <b-link size="sm" :href="explorer + 'address/' + data.item.owner" variant="link" v-b-popover.hover.ds500="'Approval owner ' + data.item.owner" target="_blank">
                        {{ data.item.owner.substring(0, 8) + '...' + data.item.owner.slice(-6) }}
                      </b-link>
                    </div>
                    <div v-else-if="data.item.type == 'ApprovalForAll'">
                      <b-link size="sm" :href="explorer + 'address/' + data.item.owner" variant="link" v-b-popover.hover.ds500="'Approval owner ' + data.item.owner" target="_blank">
                        {{ data.item.owner.substring(0, 8) + '...' + data.item.owner.slice(-6) }}
                      </b-link>
                    </div>
                  </template>
                  <template #cell(toSpenderOperator)="data">
                    <div v-if="data.item.type == 'Transfer' || data.item.type == 'TransferSingle' || data.item.type == 'TransferBatch'">
                      <b-link size="sm" :href="explorer + 'address/' + data.item.to" variant="link" v-b-popover.hover.ds500="'Transfer to ' + data.item.to" target="_blank">
                        {{ data.item.to.substring(0, 8) + '...' + data.item.to.slice(-6) }}
                      </b-link>
                    </div>
                    <div v-else-if="data.item.type == 'Approval'">
                      <b-link size="sm" :href="explorer + 'address/' + data.item.spender" variant="link" v-b-popover.hover.ds500="'Approval spender ' + data.item.spender" target="_blank">
                        {{ data.item.spender.substring(0, 8) + '...' + data.item.spender.slice(-6) }}
                      </b-link>
                    </div>
                    <div v-else-if="data.item.type == 'ApprovalForAll'">
                      <b-link size="sm" :href="explorer + 'address/' + data.item.operator" variant="link" v-b-popover.hover.ds500="'ApprovalForAll operator ' + data.item.operator" target="_blank">
                        {{ data.item.operator.substring(0, 8) + '...' + data.item.operator.slice(-6) }}
                      </b-link>
                    </div>
                  </template>
                  <template #head(tokensTokenId)="data">
                    {{ type == 721 ? "Token Id" : ( type == 1155 ? "Token Id(s)" : "Tokens") }}
                  </template>
                  <template #cell(tokensTokenId)="data">
                    <div v-if="data.item.type == 'Transfer'">
                      <div v-if="data.item.eventType == 20">
                        <font size="-2" class="text-muted">
                          {{ formatNumber(data.item.tokens) }}
                        </font>
                        {{ formatDecimals(data.item.tokens, decimals) }}
                      </div>
                      <div v-else-if="data.item.eventType == 721">
                        <b-badge pill @click="viewNonFungible(type, settings.contract, data.item.tokenId)" v-b-popover.hover.ds500="'Click to view token'" variant="info">
                          {{ data.item.tokenId }}
                        </b-badge>
                      </div>
                    </div>
                    <div v-else-if="data.item.type == 'TransferSingle'">
                      <b-badge pill @click="viewNonFungible(type, settings.contract, data.item.tokenId)" v-b-popover.hover.ds500="'Click to view token'" variant="info">
                        {{ data.item.tokenId }}
                      </b-badge>
                    </div>
                    <div v-else-if="data.item.type == 'TransferBatch'">
                      <span v-for="(item, index) of data.item.tokenIds" v-bind:key="index">
                        <b-badge pill @click="viewNonFungible(1155, settings.contract, data.item.tokenIds[index])" variant="info">
                          {{ data.item.tokenIds[index] }}
                        </b-badge>
                        <font size="-1" class="text-muted">{{ 'x' + data.item.values[index] }}</font>
                      </span>
                    </div>
                    <div v-else-if="data.item.type == 'Approval'">
                      <div v-if="data.item.eventType == 20">
                        <font size="-2" class="text-muted">
                          {{ formatNumber(data.item.tokens) }}
                        </font>
                        {{ formatDecimals(data.item.tokens, decimals) }}
                      </div>
                      <div v-else>
                        <b-badge pill @click="viewNonFungible(type, settings.contract, data.item.tokenId)" v-b-popover.hover.ds500="'Click to view token'" variant="info">
                          {{ data.item.tokenId }}
                        </b-badge>
                      </div>
                    </div>
                    <div v-else-if="data.item.type == 'ApprovalForAll'">
                      {{ data.item.approved }}
                    </div>
                  </template>
                </b-table>
              </div>

              <!-- Tokens: -->
              <div v-if="settings.tableIndex == 1">
                <b-table small fixed striped :fields="type == 20 ? tokensFieldsFungible : tokensFieldsNonFungible" :items="pagedSortedFilteredTokens" show-empty empty-html="Click [Retrieve] above" head-variant="light" class="mt-1">
                  <template #cell(number)="data">
                      <font size="-1" class="text-muted">{{ parseInt(data.index) + ((settings.tokensTable.currentPage - 1) * settings.tokensTable.pageSize) + 1 }}</font>
                  </template>
                  <template #cell(latestUpdate)="data">
                    <b-link size="sm" :href="explorer + 'tx/' + data.item.txHash + '#eventlog#' + data.item.logIndex" variant="link" v-b-popover.hover.ds500="(timestamps[chainId] && timestamps[chainId][data.item.blockNumber]) ? ('Block ' + formatNumber(data.item.blockNumber)) : 'blockNumber:txIndex'" target="_blank">
                      <font size="-1">
                        <span v-if="timestamps[chainId] && timestamps[chainId][data.item.blockNumber]">
                          {{ formatTimestamp(timestamps[chainId][data.item.blockNumber]) }}
                        </span>
                        <span v-else>
                          {{ data.item.blockNumber + ':' + data.item.txIndex }}
                        </span>
                      </font>
                    </b-link>
                    <font size="-1" v-b-popover.hover.ds500="'logIndex'" class="text-muted">{{ data.item.logIndex }}</font>
                    <font size="-1" v-b-popover.hover.ds500="'txHash'" class="text-muted">{{ data.item.txHash.substring(0, 8) + '...' + data.item.txHash.slice(-6) }}</font>
                  </template>
                  <template #cell(owner)="data">
                    <b-link size="sm" :href="explorer + 'token/' + settings.contract + '?a=' + data.item.owner" variant="link" v-b-popover.hover.ds500="data.item.owner" target="_blank">
                      {{ data.item.owner.substring(0, 8) + '...' + data.item.owner.slice(-6) }}
                    </b-link>
                  </template>
                  <template #head(owners)="data">
                    {{ type == 721 ? "Owner" : "Owner(s)" }}
                  </template>
                  <template #cell(owners)="data">
                    <b-link size="sm" :href="explorer + 'token/' + settings.contract + '?a=' + data.item.owner" variant="link" v-b-popover.hover.ds500="data.item.owner" target="_blank">
                      {{ data.item.owner.substring(0, 8) + '...' + data.item.owner.slice(-6) }}
                    </b-link>
                  </template>
                  <template #cell(tokens)="data">
                    <div v-if="type == 20">
                      <font size="-2" class="text-muted">
                        {{ formatNumber(data.item.tokens) }}
                      </font>
                      {{ formatDecimals(data.item.tokens, decimals) }}
                    </div>
                    <div v-else-if="type == 721 || type == 1155">
                      <b-badge pill @click="viewNonFungible(type, settings.contract, data.item.tokenId)" v-b-popover.hover.ds500="'Click to view token'" variant="info">
                        {{ data.item.tokenId }}
                      </b-badge>
                    </div>
                  </template>
                </b-table>
              </div>

              <!-- Approvals: -->
              <div v-if="settings.tableIndex == 2">
                <b-table small fixed striped :fields="approvalsFields" :items="pagedSortedFilteredApprovals" show-empty empty-html="Click [Retrieve] above" head-variant="light" class="mt-1">
                  <template #cell(number)="data">
                      <font size="-1" class="text-muted">{{ parseInt(data.index) + ((settings.approvalsTable.currentPage - 1) * settings.approvalsTable.pageSize) + 1 }}</font>
                  </template>
                  <template #cell(latestUpdate)="data">
                    <font size="-1">
                      <b-link size="sm" :href="explorer + 'tx/' + data.item.txHash + '#eventlog#' + data.item.logIndex" variant="link" v-b-popover.hover.ds500="(timestamps[chainId] && timestamps[chainId][data.item.blockNumber]) ? ('Block ' + formatNumber(data.item.blockNumber)) : 'blockNumber:txIndex.logIndex'" target="_blank">
                        <span v-if="timestamps[chainId] && timestamps[chainId][data.item.blockNumber]">
                          {{ formatTimestamp(timestamps[chainId][data.item.blockNumber]) }}
                        </span>
                        <span v-else>
                          {{ data.item.blockNumber + ':' + data.item.txIndex }}
                        </span>
                      </b-link>
                      <font size="-1" v-b-popover.hover.ds500="'logIndex'" class="text-muted">{{ data.item.logIndex }}</font>
                      <font size="-1" v-b-popover.hover.ds500="'txHash'" class="text-muted">{{ data.item.txHash.substring(0, 8) + '...' + data.item.txHash.slice(-6) }}</font>
                    </font>
                  </template>
                  <template #cell(owner)="data">
                    <b-link size="sm" :href="explorer + 'token/' + settings.contract + '?a=' + data.item.owner" variant="link" v-b-popover.hover.ds500="data.item.owner" target="_blank">
                      {{ data.item.owner.substring(0, 8) + '...' + data.item.owner.slice(-6) }}
                    </b-link>
                  </template>
                  <template #cell(spender)="data">
                    <b-link size="sm" :href="explorer + 'token/' + settings.contract + '?a=' + data.item.spender" variant="link" v-b-popover.hover.ds500="data.item.spender" target="_blank">
                      {{ data.item.spender.substring(0, 8) + '...' + data.item.spender.slice(-6) }}
                    </b-link>
                  </template>
                  <template #head(tokens)="data">
                    {{ type == 721 ? "Token Id" : "Tokens" }}
                  </template>
                  <template #cell(tokens)="data">
                    <div v-if="type == 20">
                      <font size="-2" class="text-muted">
                        {{ formatNumber(data.item.tokens) }}
                      </font>
                      <b-link size="sm" :href="explorer + 'tx/' + data.item.txHash + '#eventlog#' + data.item.logIndex" variant="link" v-b-popover.hover.ds500="formatDecimals(data.item.tokens, data.item.decimals)" target="_blank">
                        <span v-if="data.item.toString().length > 30">
                          &infin;
                        </span>
                        <span v-else>
                          {{ formatDecimals(data.item.tokens, erc20.decimals) }}
                        </span>
                      </b-link>
                    </div>
                    <div v-if="type == 721">
                      <b-badge pill @click="viewNonFungible(type, settings.contract, data.item.tokenId)" v-b-popover.hover.ds500="'Click to view token'" variant="info">
                        {{ data.item.tokenId }}
                      </b-badge>
                    </div>
                  </template>
                </b-table>

              </div>

              <!-- ApprovalForAlls: -->
              <div v-if="settings.tableIndex == 3">
                <b-table small fixed striped :fields="approvalForAllsFields" :items="pagedSortedFilteredApprovalForAlls" show-empty empty-html="Click [Retrieve] above" head-variant="light" class="mt-1">
                  <template #cell(number)="data">
                      <font size="-1" class="text-muted">{{ parseInt(data.index) + ((settings.approvalForAllsTable.currentPage - 1) * settings.approvalForAllsTable.pageSize) + 1 }}</font>
                  </template>
                  <template #cell(latestUpdate)="data">
                    <font size="-1">
                      <b-link size="sm" :href="explorer + 'tx/' + data.item.txHash + '#eventlog#' + data.item.logIndex" variant="link" v-b-popover.hover.ds500="(timestamps[chainId] && timestamps[chainId][data.item.blockNumber]) ? ('Block ' + formatNumber(data.item.blockNumber)) : 'blockNumber:txIndex.logIndex'" target="_blank">
                        <span v-if="timestamps[chainId] && timestamps[chainId][data.item.blockNumber]">
                          {{ formatTimestamp(timestamps[chainId][data.item.blockNumber]) }}
                        </span>
                        <span v-else>
                          {{ data.item.blockNumber + ':' + data.item.txIndex }}
                        </span>
                      </b-link>
                      <font size="-1" v-b-popover.hover.ds500="'logIndex'" class="text-muted">{{ data.item.logIndex }}</font>
                      <font size="-1" v-b-popover.hover.ds500="'txHash'" class="text-muted">{{ data.item.txHash.substring(0, 8) + '...' + data.item.txHash.slice(-6) }}</font>
                    </font>
                  </template>
                  <template #cell(owner)="data">
                    <b-link size="sm" :href="explorer + 'token/' + settings.contract + '?a=' + data.item.owner" variant="link" v-b-popover.hover.ds500="data.item.owner" target="_blank">
                      {{ data.item.owner.substring(0, 8) + '...' + data.item.owner.slice(-6) }}
                    </b-link>
                  </template>
                  <template #cell(operator)="data">
                    <b-link size="sm" :href="explorer + 'token/' + settings.contract + '?a=' + data.item.operator" variant="link" v-b-popover.hover.ds500="data.item.operator" target="_blank">
                      {{ data.item.operator.substring(0, 8) + '...' + data.item.operator.slice(-6) }}
                    </b-link>
                  </template>
                </b-table>
              </div>

            </b-card>

            <!-- ERC-20: -->
            <b-card v-if="settings.tabIndex == 2" header="ERC-20" class="m-0 p-0">
              <b-form-group label="contract:" label-for="erc20-contract" label-size="lg" label-class="font-weight-bold pt-0" label-cols-sm="2" label-align-sm="right" :state="!settings.erc20.contract || validAddress(settings.erc20.contract)" :invalid-feedback="'Invalid address'" :description="erc20Description" class="mx-0 my-1 p-0">
                <b-input-group size="sm" class="w-50">
                  <b-form-input type="text" size="sm" id="erc20-contract" v-model="settings.erc20.contract" @change="saveSettings" placeholder="Enter token contract address, or select from dropdown"></b-form-input>
                  <b-input-group-append>
                    <!-- <b-button size="sm" :disabled="!validAddress(settings.erc20.contract)" @click="retrieveERC20" variant="primary">Retrieve</b-button> -->
                    <b-dropdown size="sm" id="dropdown-left" text="" variant="link" v-b-popover.hover.ds500="'Some sample token contracts'" class="m-0 ml-1 p-0">
                      <b-dropdown-item v-if="sampleContracts(20).length == 0" disabled>No sample contracts on this network</b-dropdown-item>
                      <div v-for="(item, index) of sampleContracts(20)" v-bind:key="index">
                        <b-dropdown-item @click="settings.erc20.contract = item.contract; saveSettings();">{{ index }}. {{ item.contract.substring(0, 8) + '...' + item.contract.slice(-6) + ' ' + item.name }}</b-dropdown-item>
                      </div>
                    </b-dropdown>
                    <b-button :disabled="!settings.erc20.contract || !validAddress(settings.erc20.contract)" @click="copyToClipboard(settings.erc20.contract);" variant="link" v-b-popover.hover.ds500="'Copy ERC-20 contract address to clipboard'" class="m-0 ml-3 p-0"><b-icon-clipboard shift-v="+1" font-scale="1.1"></b-icon-clipboard></b-button>
                    <b-button size="sm" :disabled="!validAddress(settings.erc20.contract)" :href="explorer + 'token/' + settings.erc20.contract + '#code'" variant="link" v-b-popover.hover.ds500="'View in explorer'" target="_blank" class="m-0 ml-2 p-0"><b-icon-link45deg shift-v="-4" font-scale="1.1"></b-icon-link45deg></b-button>
                  </b-input-group-append>
                </b-input-group>
              </b-form-group>
              <!-- <b-form-group label="" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <b-button size="sm" :disabled="!validAddress(settings.erc20.contract)" @click="retrieveERC20" variant="primary">Retrieve</b-button>
              </b-form-group> -->
              <!-- <b-form-group label="symbol:" label-for="erc20-symbol" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <b-form-input type="text" size="sm" readonly id="erc20-symbol" :value="erc20.symbol" class="w-25"></b-form-input>
              </b-form-group> -->
              <!-- <b-form-group label="name:" label-for="erc20-name" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <b-form-input type="text" size="sm" readonly id="erc20-name" :value="erc20.name" class="w-25"></b-form-input>
              </b-form-group> -->
              <!-- <b-form-group label="decimals:" label-for="erc20-decimals" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <b-form-input type="text" size="sm" readonly id="erc20-decimals" :value="erc20.decimals" class="w-25"></b-form-input>
              </b-form-group> -->
              <!-- <b-form-group label="totalSupply:" label-for="erc20-totalsupply" label-size="sm" label-cols-sm="2" label-align-sm="right" :description="erc20.totalSupply ? 'Raw value: ' + formatNumber(erc20.totalSupply) : null" class="mx-0 my-1 p-0">
                <b-form-input type="text" size="sm" readonly id="erc20-totalsupplydecimals" :value="formatDecimals(erc20.totalSupply, erc20.decimals)" class="w-25"></b-form-input>
              </b-form-group> -->

              <b-form-group label="balanceOf:" label-size="lg" label-class="font-weight-bold pt-0" label-cols-sm="2" label-align-sm="right" class="mx-0 mt-3 mb-1 p-0">
                <b-card bg-variant="light">
                  <b-form-group label="owner:" label-for="erc20-balanceof-owner" label-size="sm" label-cols-sm="3" label-align-sm="right" :state="!settings.erc20.balanceOf.owner || validAddress(settings.erc20.balanceOf.owner)" :invalid-feedback="'Invalid address'" class="mx-0 my-1 p-0">
                    <b-input-group size="sm" class="w-50">
                      <b-form-input type="text" size="sm" id="erc20-balanceof-owner" v-model="settings.erc20.balanceOf.owner" @change="saveSettings" placeholder="owner"></b-form-input>
                      <b-input-group-append>
                        <b-button size="sm" :disabled="!validAddress(settings.erc20.balanceOf.owner)" :href="explorer + 'address/' + settings.erc20.balanceOf.owner" variant="link" v-b-popover.hover.ds500="'View in explorer'" target="_blank" class="m-0 ml-1 p-0"><b-icon-link45deg shift-v="+1" font-scale="0.95"></b-icon-link45deg></b-button>
                      </b-input-group-append>
                    </b-input-group>
                  </b-form-group>
                  <b-form-group label="" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                    <b-button size="sm" :disabled="!validAddress(settings.erc20.contract) || !validAddress(settings.erc20.balanceOf.owner)" @click="retrieveERC20BalanceOf" variant="primary">Retrieve</b-button>
                  </b-form-group>
                  <b-form-group label="balanceOf(owner):" label-for="erc20-balanceof-balance" label-size="sm" label-cols-sm="3" label-align-sm="right" :description="erc20.balanceOf ? 'Raw value: ' + formatNumber(erc20.balanceOf) : null" class="mx-0 my-1 p-0">
                    <b-form-input type="text" size="sm" readonly id="erc20-balanceof-balance" :value="formatDecimals(erc20.balanceOf, erc20.decimals)" class="w-25"></b-form-input>
                  </b-form-group>
                </b-card>
              </b-form-group>

              <b-form-group label="allowance:" label-size="lg" label-class="font-weight-bold pt-0" label-cols-sm="2" label-align-sm="right" class="mx-0 mt-3 mb-1 p-0">
                <b-card bg-variant="light">
                  <b-form-group label="owner:" label-for="erc20-allowance-owner" label-size="sm" label-cols-sm="3" label-align-sm="right" :state="!settings.erc20.allowance.owner || validAddress(settings.erc20.allowance.owner)" :invalid-feedback="'Invalid address'" class="mx-0 my-1 p-0">
                    <b-input-group size="sm" class="w-50">
                      <b-form-input type="text" size="sm" id="erc20-allowance-owner" v-model="settings.erc20.allowance.owner" @change="saveSettings" placeholder="owner"></b-form-input>
                      <b-input-group-append>
                        <b-button size="sm" :disabled="!validAddress(settings.erc20.allowance.owner)" :href="explorer + 'address/' + settings.erc20.allowance.owner" variant="link" v-b-popover.hover.ds500="'View in explorer'" target="_blank" class="m-0 ml-1 p-0"><b-icon-link45deg shift-v="+1" font-scale="0.95"></b-icon-link45deg></b-button>
                      </b-input-group-append>
                    </b-input-group>
                  </b-form-group>
                  <b-form-group label="spender:" label-for="erc20-allowance-spender" label-size="sm" label-cols-sm="3" label-align-sm="right" :state="!settings.erc20.allowance.spender || validAddress(settings.erc20.allowance.spender)" :invalid-feedback="'Invalid address'" class="mx-0 my-1 p-0">
                    <b-input-group size="sm" class="w-50">
                      <b-form-input type="text" size="sm" id="erc20-allowance-spender" v-model="settings.erc20.allowance.spender" @change="saveSettings" placeholder="spender"></b-form-input>
                      <b-input-group-append>
                        <b-button size="sm" :disabled="!validAddress(settings.erc20.allowance.spender)" :href="explorer + 'address/' + settings.erc20.allowance.spender" variant="link" v-b-popover.hover.ds500="'View in explorer'" target="_blank" class="m-0 ml-1 p-0"><b-icon-link45deg shift-v="+1" font-scale="0.95"></b-icon-link45deg></b-button>
                      </b-input-group-append>
                    </b-input-group>
                  </b-form-group>
                  <b-form-group label="" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                    <b-button size="sm" :disabled="!validAddress(settings.erc20.contract) || !validAddress(settings.erc20.allowance.owner) || !validAddress(settings.erc20.allowance.spender)" @click="retrieveERC20Allowance" variant="primary">Retrieve</b-button>
                  </b-form-group>
                  <b-form-group label="allowance(owner, spender):" label-for="erc20-allowance-tokens" label-size="sm" label-cols-sm="3" label-align-sm="right" :description="erc20.allowance ? 'Raw value: ' + formatNumber(erc20.allowance) : null" class="mx-0 my-1 p-0">
                    <b-form-input type="text" size="sm" readonly id="erc20-allowance-tokens" :value="formatDecimals(erc20.allowance, erc20.decimals)" class="w-25"></b-form-input>
                  </b-form-group>
                </b-card>
              </b-form-group>

              <b-form-group label="transfer:" label-size="lg" label-class="font-weight-bold pt-0" label-cols-sm="2" label-align-sm="right" class="mx-0 mt-3 mb-1 p-0">
                <b-card bg-variant="light">
                  <b-form-group label="msg.sender:" label-for="erc20-transfer-coinbase" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                    <b-input-group size="sm" class="w-50">
                      <b-form-input type="text" size="sm" readonly id="erc20-transfer-coinbase" v-model="coinbase"></b-form-input>
                      <b-input-group-append>
                        <b-button size="sm" :href="explorer + 'token/' + settings.erc20.contract + '?a=' + coinbase" variant="link" v-b-popover.hover.ds500="'View in explorer'" target="_blank" class="m-0 ml-1 p-0"><b-icon-link45deg shift-v="+1" font-scale="0.95"></b-icon-link45deg></b-button>
                      </b-input-group-append>
                    </b-input-group>
                  </b-form-group>
                  <b-form-group label="" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                    <!-- <b-button size="sm" @click="retrieveERC20" variant="primary">Retrieve</b-button> -->
                  </b-form-group>
                  <b-form-group label="balanceOf(msg.sender):" label-for="erc20-transfer-coinbasebalanceof" label-size="sm" label-cols-sm="3" label-align-sm="right" :description="erc20.coinbaseBalanceOf ? 'Raw value: ' + formatNumber(erc20.coinbaseBalanceOf) : 'Click [Retrieve] above'" class="mx-0 my-1 p-0">
                    <b-form-input type="text" size="sm" readonly id="erc20-transfer-coinbasebalanceof" :value="formatDecimals(erc20.coinbaseBalanceOf, erc20.decimals)" class="w-25"></b-form-input>
                  </b-form-group>
                  <b-form-group label="to:" label-for="erc20-transfer-to" label-size="sm" label-cols-sm="3" label-align-sm="right" :state="!settings.erc20.transfer.to || validAddress(settings.erc20.transfer.to)" :invalid-feedback="'Invalid address'" class="mx-0 my-1 p-0">
                    <b-input-group size="sm" class="w-50">
                      <b-form-input type="text" size="sm" id="erc20-transfer-to" v-model="settings.erc20.transfer.to" @change="saveSettings" placeholder="to"></b-form-input>
                      <b-input-group-append>
                        <b-button size="sm" :disabled="!validAddress(settings.erc20.transfer.to)" :href="explorer + 'address/' + settings.erc20.transfer.to" variant="link" v-b-popover.hover.ds500="'View in explorer'" target="_blank" class="m-0 ml-1 p-0"><b-icon-link45deg shift-v="+1" font-scale="0.95"></b-icon-link45deg></b-button>
                      </b-input-group-append>
                    </b-input-group>
                  </b-form-group>
                  <b-form-group label="tokens:" label-for="erc20-transfer-tokens" label-size="sm" label-cols-sm="3" label-align-sm="right" :state="!settings.erc20.transfer.tokens || validNumber(settings.erc20.transfer.tokens)" :invalid-feedback="'Invalid number'" class="mx-0 my-1 p-0">
                    <b-form-input type="text" size="sm" id="erc20-transfer-tokens" v-model="settings.erc20.transfer.tokens" @change="saveSettings" class="w-25"></b-form-input>
                  </b-form-group>
                  <b-form-group label="" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                    <b-button size="sm" :disabled="!validAddress(settings.erc20.contract) || !validAddress(settings.erc20.transfer.to) || !validNumber(settings.erc20.transfer.tokens)" @click="transferERC20" variant="warning">Transfer</b-button>
                  </b-form-group>
                  <b-form-group label="txHash:" label-for="erc20-transfer-txhash" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                    <b-input-group size="sm" class="w-75">
                      <b-form-input type="text" size="sm" readonly id="erc20-transfer-txhash" v-model="erc20.transferTx.txHash"></b-form-input>
                      <b-input-group-append>
                        <b-button size="sm" :disabled="!erc20.transferTx.txHash" :href="explorer + 'tx/' + erc20.transferTx.txHash" variant="link" v-b-popover.hover.ds500="'View in explorer'" target="_blank" class="m-0 ml-1 p-0"><b-icon-link45deg shift-v="+1" font-scale="0.95"></b-icon-link45deg></b-button>
                      </b-input-group-append>
                    </b-input-group>
                  </b-form-group>
                  <b-form-group label="results:" label-for="erc20-transfer-results" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                    <b-form-textarea size="sm" plaintext id="erc20-transfer-results" :value="erc20.transferTx.result" rows="3" max-rows="10" style="background: white; " class="w-100"></b-form-textarea>
                  </b-form-group>
                </b-card>
              </b-form-group>

              <b-form-group label="approve:" label-size="lg" label-class="font-weight-bold pt-0" label-cols-sm="2" label-align-sm="right" class="mx-0 mt-3 mb-1 p-0">
                <b-card bg-variant="light">
                  <b-form-group label="msg.sender:" label-for="erc20-approve-coinbase" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                    <b-input-group size="sm" class="w-50">
                      <b-form-input type="text" size="sm" readonly id="erc20-approve-coinbase" v-model="coinbase"></b-form-input>
                      <b-input-group-append>
                        <b-button size="sm" :href="explorer + 'token/' + settings.erc20.contract + '?a=' + coinbase" variant="link" v-b-popover.hover.ds500="'View in explorer'" target="_blank" class="m-0 ml-1 p-0"><b-icon-link45deg shift-v="+1" font-scale="0.95"></b-icon-link45deg></b-button>
                      </b-input-group-append>
                    </b-input-group>
                  </b-form-group>
                  <b-form-group label="spender:" label-for="erc20-approve-spender" label-size="sm" label-cols-sm="3" label-align-sm="right" :state="!settings.erc20.approve.spender || validAddress(settings.erc20.approve.spender)" :invalid-feedback="'Invalid address'" class="mx-0 my-1 p-0">
                    <b-input-group size="sm" class="w-50">
                      <b-form-input type="text" size="sm" id="erc20-approve-spender" v-model="settings.erc20.approve.spender" @change="saveSettings" placeholder="spender"></b-form-input>
                      <b-input-group-append>
                        <b-button size="sm" :disabled="!validAddress(settings.erc20.approve.spender)" :href="explorer + 'address/' + settings.erc20.approve.spender" variant="link" v-b-popover.hover.ds500="'View in explorer'" target="_blank" class="m-0 ml-1 p-0"><b-icon-link45deg shift-v="+1" font-scale="0.95"></b-icon-link45deg></b-button>
                      </b-input-group-append>
                    </b-input-group>
                  </b-form-group>
                  <b-form-group label="tokens:" label-for="erc20-approve-tokens" label-size="sm" label-cols-sm="3" label-align-sm="right" :state="!settings.erc20.approve.tokens || validNumber(settings.erc20.approve.tokens)" :invalid-feedback="'Invalid number'"class="mx-0 my-1 p-0">
                    <b-form-input type="text" size="sm" id="erc20-approve-tokens" v-model="settings.erc20.approve.tokens" @change="saveSettings"  placeholder="e.g., 1.2345" class="w-25"></b-form-input>
                  </b-form-group>
                  <b-form-group label="" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                    <b-button size="sm" :disabled="!validAddress(settings.erc20.contract) || !validAddress(settings.erc20.approve.spender) || !validNumber(settings.erc20.approve.tokens)" @click="approveERC20" variant="warning">Approve</b-button>
                  </b-form-group>
                  <b-form-group label="txHash:" label-for="erc20-approve-txhash" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                    <b-input-group size="sm" class="w-75">
                      <b-form-input type="text" size="sm" readonly id="erc20-approve-txhash" v-model="erc20.approveTx.txHash"></b-form-input>
                      <b-input-group-append>
                        <b-button size="sm" :disabled="!erc20.approveTx.txHash" :href="explorer + 'tx/' + erc20.approveTx.txHash" variant="link" v-b-popover.hover.ds500="'View in explorer'" target="_blank" class="m-0 ml-1 p-0"><b-icon-link45deg shift-v="+1" font-scale="0.95"></b-icon-link45deg></b-button>
                      </b-input-group-append>
                    </b-input-group>
                  </b-form-group>
                  <b-form-group label="results:" label-for="erc20-approve-results" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                    <b-form-textarea size="sm" plaintext id="erc20-approve-results" :value="erc20.approveTx.result" rows="3" max-rows="10" style="background: white; " class="w-100"></b-form-textarea>
                  </b-form-group>
                </b-card>
              </b-form-group>

              <b-form-group label="transferfrom:" label-size="lg" label-class="font-weight-bold pt-0" label-cols-sm="2" label-align-sm="right" class="mx-0 mt-3 mb-1 p-0">
                <b-card bg-variant="light">
                  <b-form-group label="msg.sender:" label-for="erc20-transferfrom-coinbase" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                    <b-input-group size="sm" class="w-50">
                      <b-form-input type="text" size="sm" readonly id="erc20-transferfrom-coinbase" v-model="coinbase"></b-form-input>
                      <b-input-group-append>
                        <b-button size="sm" :href="explorer + 'token/' + settings.erc20.contract + '?a=' + coinbase" variant="link" v-b-popover.hover.ds500="'View in explorer'" target="_blank" class="m-0 ml-1 p-0"><b-icon-link45deg shift-v="+1" font-scale="0.95"></b-icon-link45deg></b-button>
                      </b-input-group-append>
                    </b-input-group>
                  </b-form-group>
                  <b-form-group label="from:" label-for="erc20-transferfrom-from" label-size="sm" label-cols-sm="3" label-align-sm="right" :state="!settings.erc20.transferFrom.from || validAddress(settings.erc20.transferFrom.from)" :invalid-feedback="'Invalid address'" class="mx-0 my-1 p-0">
                    <b-input-group size="sm" class="w-50">
                      <b-form-input type="text" size="sm" id="erc20-transferfrom-from" v-model="settings.erc20.transferFrom.from" @change="saveSettings" placeholder="from"></b-form-input>
                      <b-input-group-append>
                        <b-button size="sm" :disabled="!validAddress(settings.erc20.transferFrom.from)" :href="explorer + 'address/' + settings.erc20.transferFrom.from" variant="link" v-b-popover.hover.ds500="'View in explorer'" target="_blank" class="m-0 ml-1 p-0"><b-icon-link45deg shift-v="+1" font-scale="0.95"></b-icon-link45deg></b-button>
                      </b-input-group-append>
                    </b-input-group>
                  </b-form-group>
                  <b-form-group label="to:" label-for="erc20-transferfrom-to" label-size="sm" label-cols-sm="3" label-align-sm="right" :state="!settings.erc20.transferFrom.to || validAddress(settings.erc20.transferFrom.to)" :invalid-feedback="'Invalid address'" class="mx-0 my-1 p-0">
                    <b-input-group size="sm" class="w-50">
                      <b-form-input type="text" size="sm" id="erc20-transferfrom-to" v-model="settings.erc20.transferFrom.to" @change="saveSettings" placeholder="to"></b-form-input>
                      <b-input-group-append>
                        <b-button size="sm" :disabled="!validAddress(settings.erc20.transferFrom.to)" :href="explorer + 'address/' + settings.erc20.transferFrom.to" variant="link" v-b-popover.hover.ds500="'View in explorer'" target="_blank" class="m-0 ml-1 p-0"><b-icon-link45deg shift-v="+1" font-scale="0.95"></b-icon-link45deg></b-button>
                      </b-input-group-append>
                    </b-input-group>
                  </b-form-group>
                  <b-form-group label="tokens:" label-for="erc20-transferfrom-tokens" label-size="sm" label-cols-sm="3" label-align-sm="right" :state="!settings.erc20.transferFrom.tokens || validNumber(settings.erc20.transferFrom.tokens)" :invalid-feedback="'Invalid number'"class="mx-0 my-1 p-0">
                    <b-form-input type="text" size="sm" id="erc20-transferfrom-tokens" v-model="settings.erc20.transferFrom.tokens" @change="saveSettings"  placeholder="e.g., 2.3456" class="w-25"></b-form-input>
                  </b-form-group>
                  <b-form-group label="" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                    <b-button size="sm" :disabled="!validAddress(settings.erc20.contract) || !validAddress(settings.erc20.transferFrom.from) || !validAddress(settings.erc20.transferFrom.to) || !validNumber(settings.erc20.transferFrom.tokens)" @click="transferFromERC20" variant="warning">Transfer From</b-button>
                  </b-form-group>
                  <b-form-group label="txHash:" label-for="erc20-transferfrom-txhash" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                    <b-input-group size="sm" class="w-75">
                      <b-form-input type="text" size="sm" readonly id="erc20-transferfrom-txhash" v-model="erc20.transferFromTx.txHash"></b-form-input>
                      <b-input-group-append>
                        <b-button size="sm" :disabled="!erc20.transferFromTx.txHash" :href="explorer + 'tx/' + erc20.transferFromTx.txHash" variant="link" v-b-popover.hover.ds500="'View in explorer'" target="_blank" class="m-0 ml-1 p-0"><b-icon-link45deg shift-v="+1" font-scale="0.95"></b-icon-link45deg></b-button>
                      </b-input-group-append>
                    </b-input-group>
                  </b-form-group>
                  <b-form-group label="results:" label-for="erc20-transferfrom-results" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                    <b-form-textarea size="sm" plaintext id="erc20-transferfrom-results" :value="erc20.transferFromTx.result" rows="3" max-rows="10" style="background: white; " class="w-100"></b-form-textarea>
                  </b-form-group>
                </b-card>
              </b-form-group>
            </b-card>

          </b-card>
        </b-card>

        <b-card no-header body-class="m-0 p-0" class="m-0 p-0 border-0">
          <div class="d-flex flex-wrap m-0 p-0">
            <div class="ml-0 mt-1 pl-1">
              <font v-if="connected" size="-2">
                <b-link v-if="coinbase" :href="explorer + 'address/' + coinbase" v-b-popover.hover.ds500="'Coinbase'" target="_blank">
                  {{ coinbase && (coinbase.substring(0, 8) + '...' + coinbase.slice(-6)) || 'Connect' }}
                </b-link>
                <b-link v-if="chainId" :href="explorer + ''" v-b-popover.hover.ds500="'Network'" target="_blank">
                  {{ networkName }}
                </b-link>
                <b-link v-if="blockNumber" :href="explorer + 'block/' + blockNumber" v-b-popover.hover.ds500="'Latest block'" target="_blank">
                  {{ '#' + formatNumber(blockNumber) }}
                </b-link>
                <b-link v-if="blockNumber" :href="explorer + 'block/' + blockNumber" v-b-popover.hover.ds500="formatTimestamp(timestamp)" target="_blank">
                  {{ formatTimeDiff(timestamp) }}
                </b-link>
              </font>
            </div>
            <div class="mt-0 flex-grow-1">
            </div>
            <div class="mt-0 pl-1 pr-1">
              gm, and enjoy! <b-link href="https://github.com/bokkypoobah/TokenExplorer" target="_blank"><i>TokenExplorer</i></b-link> &copy; Bok Consulting Pty Ltd 2024
            </div>
          </div>
        </b-card>
      </b-container>
    </div>

    <script>
      window.app = new Vue({
        el: '#app',
        // --- DATA ---
        data: {
          connected: false,
          chainId: null,
          coinbase: null,
          blockNumber: null,
          timestamp: null,
          forceRefresh: 0,

          settings: {
            tabIndex: 0,

            // --- New ---
            contract: null,
            filter: null,
            tokenIdFilter: null,
            blockTxHashFilter: null,
            tableIndex: 0,
            eventsTable: {
              currentPage: 1,
              pageSize: 10,
              sortOption: 'txorderdsc',
            },
            tokensTable: {
              currentPage: 1,
              pageSize: 10,
              sortOptionERC20: 'txorderdsc',
              sortOptionERC721: 'txorderdsc',
              sortOptionERC1155: 'txorderdsc',
            },
            approvalsTable: {
              currentPage: 1,
              pageSize: 10,
              sortOption: 'txorderdsc',
            },
            approvalForAllsTable: {
              currentPage: 1,
              pageSize: 10,
              sortOption: 'txorderdsc',
            },
            version: 2,
          },

          type: null,
          symbol: null,
          name: null,
          decimals: null,
          totalSupply: null,
          description: null,
          events: [],
          tokens: [],
          approvalForAlls: [],
          approvals: [],

          // TODO Delete below eventually
          erc20: {
            symbol: null,
            name: null,
            decimals: null,
            totalSupply: null,
            coinbaseBalanceOf: null,
            balanceOf: null,
            allowance: null,
            transferTx: {
              txHash: null,
              result: null,
            },
            approveTx: {
              txHash: null,
              result: null,
            },
            transferFromTx: {
              txHash: null,
              result: null,
            },
          },
          modalNonFungible: {
            show: false,
            type: null,
            contract: null,
            tokenId: null,
            name: null,
            description: null,
            image: null,
            attributes: [],
            logs: [],
          },
          timestamps: {},
          eventsSortOptions: [
            { value: 'txorderasc', text: '▲ TxOrder' },
            { value: 'txorderdsc', text: '▼ TxOrder' },
          ],
          erc20TokensSortOptions: [
            { value: 'txorderasc', text: '▲ Latest Update' },
            { value: 'txorderdsc', text: '▼ Latest Update' },
            { value: 'ownerasc', text: '▲ Owner' },
            { value: 'ownerdsc', text: '▼ Owner' },
            { value: 'balanceasc', text: '▲ Balance' },
            { value: 'balancedsc', text: '▼ Balance' },
          ],
          erc721And1155TokensSortOptions: [
            { value: 'txorderasc', text: '▲ Latest Update' },
            { value: 'txorderdsc', text: '▼ Latest Update' },
            { value: 'tokenidasc', text: '▲ Token Id, ▲ Owner' },
            { value: 'tokeniddsc', text: '▼ Token Id, ▲ Owner' },
            { value: 'ownerasc', text: '▲ Owner, ▲ Token Id' },
            { value: 'ownerdsc', text: '▼ Owner, ▲ Token Id' },
          ],
          approvalsSortOptions: [
            { value: 'txorderasc', text: '▲ Latest Update' },
            { value: 'txorderdsc', text: '▼ Latest Update' },
            { value: 'ownerasc', text: '▲ Owner' },
            { value: 'ownerdsc', text: '▼ Owner' },
            { value: 'spenderasc', text: '▲ Spender' },
            { value: 'spenderdsc', text: '▼ Spender' },
            { value: 'tokensasc', text: '▲ Token[s/ Id]' },
            { value: 'tokensdsc', text: '▼ Token[s/ Id]' },
          ],
          erc721And1155ApprovalForAllsSortOptions: [
            { value: 'txorderasc', text: '▲ Latest Update' },
            { value: 'txorderdsc', text: '▼ Latest Update' },
            { value: 'ownerasc', text: '▲ Owner, ▼ Latest Update' },
            { value: 'ownerdsc', text: '▼ Owner, ▼ Latest Update' },
            { value: 'operatorasc', text: '▲ Operator, ▼ Latest Update' },
            { value: 'operatordsc', text: '▼ Operator, ▼ Latest Update' },
            { value: 'approvedasc', text: '▲ Approved, ▼ Latest Update' },
            { value: 'approveddsc', text: '▼ Approved, ▼ Latest Update' },
          ],
          pageSizes: [
            { value: 5, text: '5' },
            { value: 10, text: '10' },
            { value: 25, text: '25' },
            { value: 50, text: '50' },
            { value: 100, text: '100' },
            { value: 500, text: '500' },
            { value: 1000, text: '1k' },
            { value: 2500, text: '2.5k' },
            { value: 10000, text: '10k' },
          ],

          eventsFields: [
            { key: 'number', label: '#', sortable: false, thStyle: 'width: 5%;', tdClass: 'text-truncate' },
            { key: 'when', label: 'When', sortable: false, thStyle: 'width: 30%;', thClass: 'text-left', tdClass: 'text-left' },
            { key: 'type', label: 'Type', sortable: false, thStyle: 'width: 10%;', tdClass: 'text-truncate' },
            { key: 'fromOwner', label: 'From / Owner', sortable: false, thStyle: 'width: 15%;', tdClass: 'text-truncate' },
            { key: 'toSpenderOperator', label: 'To / Spender / Operator', sortable: false, thStyle: 'width: 15%;', tdClass: 'text-truncate' },
            { key: 'tokensTokenId', label: 'Tokens / Token Id', sortable: false, thStyle: 'width: 25%;', thClass: 'text-right', tdClass: 'text-right' },
          ],
          tokensFieldsFungible: [
            { key: 'number', label: '#', sortable: false, thStyle: 'width: 5%;', tdClass: 'text-truncate' },
            { key: 'latestUpdate', label: 'Latest Update', sortable: false, thStyle: 'width: 30%;', thClass: 'text-left', tdClass: 'text-left' },
            { key: 'owner', label: 'Owner', sortable: false, thStyle: 'width: 35%;', thClass: 'text-left', tdClass: 'text-left' },
            { key: 'tokens', label: 'Tokens', sortable: false, thStyle: 'width: 30%;', thClass: 'text-right', tdClass: 'text-right' },
          ],
          tokensFieldsNonFungible: [
            { key: 'number', label: '#', sortable: false, thStyle: 'width: 5%;', tdClass: 'text-truncate' },
            { key: 'latestUpdate', label: 'Latest Update', sortable: false, thStyle: 'width: 30%;', thClass: 'text-left', tdClass: 'text-left' },
            { key: 'tokens', label: 'Token Id', sortable: false, thStyle: 'width: 30%;', thClass: 'text-right', tdClass: 'text-right' },
            { key: 'owners', label: 'Owner(s)', sortable: false, thStyle: 'width: 35%;', thClass: 'text-left', tdClass: 'text-left' },
          ],
          approvalsFields: [
            { key: 'number', label: '#', sortable: false, thStyle: 'width: 5%;', tdClass: 'text-truncate' },
            { key: 'latestUpdate', label: 'Latest Update', sortable: false, thStyle: 'width: 30%;', thClass: 'text-left', tdClass: 'text-left' },
            { key: 'owner', label: 'Owner', sortable: false, thStyle: 'width: 20%;', thClass: 'text-left', tdClass: 'text-left' },
            { key: 'spender', label: 'Spender', sortable: false, thStyle: 'width: 20%;', thClass: 'text-left', tdClass: 'text-left' },
            { key: 'tokens', label: 'Tokens', sortable: false, thStyle: 'width: 25%;', thClass: 'text-right', tdClass: 'text-right' },
          ],

          approvalForAllsFields: [
            { key: 'number', label: '#', sortable: false, thStyle: 'width: 5%;', tdClass: 'text-truncate' },
            { key: 'latestUpdate', label: 'Latest Update', sortable: false, thStyle: 'width: 30%;', thClass: 'text-left', tdClass: 'text-left' },
            { key: 'owner', label: 'Owner', sortable: false, thStyle: 'width: 20%;', thClass: 'text-left', tdClass: 'text-left' },
            { key: 'operator', label: 'Operator', sortable: false, thStyle: 'width: 20%;', thClass: 'text-left', tdClass: 'text-left' },
            { key: 'approved', label: 'Approved', sortable: false, thStyle: 'width: 25%;', thClass: 'text-right', tdClass: 'text-right' },
          ],
        },

        // --- COMPUTED ---
        computed: {
          network() {
            return NETWORKS[this.chainId] || {};
          },
          networkName() {
            return this.network.name || "Unknown - chainId: " + this.chainId;
          },
          explorer() {
            return this.network.explorer || "https://etherscan.io/";
          },
          nonFungibleViewer() {
            return this.network.nonFungibleViewer || "https://opensea.io/assets/ethereum/${contract}/${tokenId}";
          },
          erc20Description() {
            if (this.erc20.symbol || this.erc20.name || this.erc20.decimals || this.erc20.totalSupply) {
              return "symbol: '" + (this.erc20.symbol || '') + "', name: '" + (this.erc20.name || '') + "', decimals: " + (this.erc20.decimals || '') + ", totalSupply: " + (this.erc20.totalSupply && this.formatDecimals(this.erc20.totalSupply, this.erc20.decimals || 0) || '');
            }
            return null;
          },

          // --- Explorer: ---
          filterRegexes() {
            console.log(now() + " INFO filterRegexes: " + this.settings.filter + "/" + this.settings.tokenIdFilter + "/" + this.settings.blockTxHashFilter);
            let regex = null;
            if (this.settings.filter != null && this.settings.filter.length > 0) {
              try {
                regex = new RegExp(this.settings.filter, 'i');
              } catch (e) {
                console.log(now() + " ERROR filterRegexes - regex error: " + e.message);
                regex = new RegExp(/thequickbrowndogjumpsoverthelazyfox/, 'i');
              }
            }
            let tokenIdRegex = null;
            if (this.settings.tokenIdFilter != null && this.settings.tokenIdFilter.length > 0) {
              try {
                tokenIdRegex = new RegExp(this.settings.tokenIdFilter, 'i');
              } catch (e) {
                console.log(now() + " ERROR filterRegexes - tokenIdRegex error: " + e.message);
                tokenIdRegex = new RegExp(/thequickbrowndogjumpsoverthelazyfox/, 'i');
              }
            }
            let blockTxHashRegex = null;
            if (this.settings.blockTxHashFilter != null && this.settings.blockTxHashFilter.length > 0) {
              try {
                blockTxHashRegex = new RegExp(this.settings.blockTxHashFilter, 'i');
              } catch (e) {
                console.log(now() + " ERROR filterRegexes - blockTxHashFilter error: " + e.message);
                blockTxHashRegex = new RegExp(/thequickbrowndogjumpsoverthelazyfox/, 'i');
              }
            }
            return { regex, tokenIdRegex, blockTxHashRegex };
          },
          sortedFilteredEvents() {
            // console.log(now() + " sortedFilteredEvents");
            const results = [];
            const { regex, tokenIdRegex, blockTxHashRegex } = this.filterRegexes;
            for (const item of this.events) {
              let include = true;
              if (regex) {
                if (item.type == "Transfer") {
                  if (item.eventType == 721) {
                    if (!(regex.test(item.from) || regex.test(item.to) || regex.test(item.txHash) || regex.test(item.blockNumber.toString()) || regex.test(item.tokenId.toString()))) {
                      include = false;
                    }
                  } else {
                    if (!(regex.test(item.from) || regex.test(item.to) || regex.test(item.txHash) || regex.test(item.blockNumber.toString()))) {
                      include = false;
                    }
                  }
                } else if (item.type == "TransferSingle") {
                  if (!(regex.test(item.from) || regex.test(item.to) || regex.test(item.txHash) || regex.test(item.blockNumber.toString()) || regex.test(item.tokenId.toString()))) {
                    include = false;
                  }
                } else if (item.type == "TransferBatch") {
                  // TODO: Scan tokenIds
                  if (!(regex.test(item.from) || regex.test(item.to) || regex.test(item.txHash) || regex.test(item.blockNumber.toString()))) {
                    include = false;
                  }
                } else if (item.type == "Approval") {
                  if (!(regex.test(item.owner) || regex.test(item.spender) || regex.test(item.txHash) || regex.test(item.blockNumber))) {
                    include = false;
                  }
                } else if (item.type == "ApprovalForAll") {
                  if (!(regex.test(item.owner) || regex.test(item.operator) || regex.test(item.txHash) || regex.test(item.blockNumber))) {
                    include = false;
                  }
                }
              }
              if (include && blockTxHashRegex) {
                if (!(blockTxHashRegex.test(item.txHash) || blockTxHashRegex.test(item.blockNumber))) {
                  include = false;
                }
              }
              if (include) {
                results.push(item);
              }
            }
            if (this.settings.eventsTable.sortOption == "txorderasc") {
              results.sort((a, b) => {
                if (a.blockNumber == b.blockNumber) {
                  return a.logIndex - b.logIndex;
                } else {
                  return a.blockNumber - b.blockNumber;
                }
              });
            } else if (this.settings.eventsTable.sortOption == "txorderdsc") {
              results.sort((a, b) => {
                if (a.blockNumber == b.blockNumber) {
                  return b.logIndex - a.logIndex;
                } else {
                  return b.blockNumber - a.blockNumber;
                }
              });
            }
            return results;
          },
          pagedSortedFilteredEvents() {
            return this.sortedFilteredEvents.slice((this.settings.eventsTable.currentPage - 1) * this.settings.eventsTable.pageSize, this.settings.eventsTable.currentPage * this.settings.eventsTable.pageSize);
          },

          sortedFilteredTokens() {
            console.log(now() + " sortedFilteredTokens - this.tokens[0..3]: " + JSON.stringify(this.tokens.slice(0, 4), null, 2));
            const results = [];
            const { regex, tokenIdRegex, blockTxHashRegex } = this.filterRegexes;
            for (const item of this.tokens) {
              let include = true;
              if (regex) {
                if (!(regex.test(item.owner))) {
                  include = false;
                }
              }
              if (include && tokenIdRegex && (this.type == 721 || this.type == 1155)) {
                if (!(tokenIdRegex.test(item.tokenId))) {
                  include = false;
                }
              }
              if (include && blockTxHashRegex) {
                console.log(JSON.stringify(item));
                if (!(blockTxHashRegex.test(item.txHash) || blockTxHashRegex.test(item.blockNumber))) {
                  include = false;
                }
              }
              if (include) {
                results.push(item);
              }
            }
            if (this.type == 20) {
              if (this.settings.tokensTable.sortOptionERC20 == "txorderasc") {
                results.sort((a, b) => {
                  if (a.blockNumber == b.blockNumber) {
                    return a.logIndex - b.logIndex;
                  } else {
                    return a.blockNumber - b.blockNumber;
                  }
                });
              } else if (this.settings.tokensTable.sortOptionERC20 == "txorderdsc") {
                results.sort((a, b) => {
                  if (a.blockNumber == b.blockNumber) {
                    return b.logIndex - a.logIndex;
                  } else {
                    return b.blockNumber - a.blockNumber;
                  }
                });
              } else if (this.settings.tokensTable.sortOptionERC20 == "ownerasc") {
                results.sort((a, b) => {
                  return ('' + a.owner).localeCompare(b.owner);
                });
              } else if (this.settings.tokensTable.sortOptionERC20 == "ownerdsc") {
                results.sort((a, b) => {
                  return ('' + b.owner).localeCompare(a.owner);
                });
              } else if (this.settings.tokensTable.sortOptionERC20 == "balanceasc") {
                results.sort((a, b) => {
                  return a.tokens - b.tokens;
                });
              } else if (this.settings.tokensTable.sortOptionERC20 == "balancedsc") {
                results.sort((a, b) => {
                  return b.tokens - a.tokens;
                });
              }
            } else if (this.type == 721) {
              if (this.settings.tokensTable.sortOptionERC721 == "txorderasc") {
                results.sort((a, b) => {
                  if (a.blockNumber == b.blockNumber) {
                    return a.logIndex - b.logIndex;
                  } else {
                    return a.blockNumber - b.blockNumber;
                  }
                });
              } else if (this.settings.tokensTable.sortOptionERC721 == "txorderdsc") {
                results.sort((a, b) => {
                  if (a.blockNumber == b.blockNumber) {
                    return b.logIndex - a.logIndex;
                  } else {
                    return b.blockNumber - a.blockNumber;
                  }
                });
              } else if (this.settings.tokensTable.sortOptionERC721 == "tokenidasc") {
                results.sort((a, b) => {
                  return a.tokenId - b.tokenId;
                });
              } else if (this.settings.tokensTable.sortOptionERC721 == "tokeniddsc") {
                results.sort((a, b) => {
                  return b.tokenId - a.tokenId;
                });
              } else if (this.settings.tokensTable.sortOptionERC721 == "ownerasc") {
                results.sort((a, b) => {
                  return ('' + a.owner).localeCompare(b.owner);
                });
              } else if (this.settings.tokensTable.sortOptionERC721 == "ownerdsc") {
                results.sort((a, b) => {
                  return ('' + b.owner).localeCompare(a.owner);
                });
              }
            } else if (this.type == 1155) {
              if (this.settings.tokensTable.sortOptionERC1155 == "txorderasc") {
                results.sort((a, b) => {
                  if (a.blockNumber == b.blockNumber) {
                    return a.logIndex - b.logIndex;
                  } else {
                    return a.blockNumber - b.blockNumber;
                  }
                });
              } else if (this.settings.tokensTable.sortOptionERC1155 == "txorderdsc") {
                results.sort((a, b) => {
                  if (a.blockNumber == b.blockNumber) {
                    return b.logIndex - a.logIndex;
                  } else {
                    return b.blockNumber - a.blockNumber;
                  }
                });
              } else if (this.settings.tokensTable.sortOptionERC1155 == "tokenidasc") {
                results.sort((a, b) => {
                  if (a.tokenId == b.tokenId) {
                    return ('' + a.owner).localeCompare(b.owner);
                  } else {
                    return a.tokenId - b.tokenId;
                  }
                });
              } else if (this.settings.tokensTable.sortOptionERC1155 == "tokeniddsc") {
                results.sort((a, b) => {
                  if (a.tokenId == b.tokenId) {
                    return ('' + a.owner).localeCompare(b.owner);
                  } else {
                    return b.tokenId - a.tokenId;
                  }
                });
              } else if (this.settings.tokensTable.sortOptionERC1155 == "ownerasc") {
                results.sort((a, b) => {
                  if (('' + a.owner).localeCompare(b.owner) == 0) {
                    return a.tokenId - b.tokenId;
                  } else {
                    return ('' + a.owner).localeCompare(b.owner);
                  }
                });
              } else if (this.settings.tokensTable.sortOptionERC1155 == "ownerdsc") {
                results.sort((a, b) => {
                  if (('' + a.owner).localeCompare(b.owner) == 0) {
                    return a.tokenId - b.tokenId;
                  } else {
                    return ('' + b.owner).localeCompare(a.owner);
                  }
                });
              }
            }
            return results;
          },
          pagedSortedFilteredTokens() {
            return this.sortedFilteredTokens.slice((this.settings.eventsTable.currentPage - 1) * this.settings.eventsTable.pageSize, this.settings.eventsTable.currentPage * this.settings.eventsTable.pageSize);
          },

          sortedFilteredApprovals() {
            // console.log(now() + " sortedFilteredApprovals");
            const results = [];
            const { regex, tokenIdRegex, blockTxHashRegex } = this.filterRegexes;
            for (const item of this.approvals) {
              let include = true;
              if (regex) {
                if (!(regex.test(item.owner) || regex.test(item.spender))) {
                  include = false;
                }
              }
              if (include && tokenIdRegex && this.type == 721) {
                if (!(tokenIdRegex.test(item.tokenId))) {
                  include = false;
                }
              }
              if (include && blockTxHashRegex) {
                console.log(JSON.stringify(item));
                if (!(blockTxHashRegex.test(item.txHash) || blockTxHashRegex.test(item.blockNumber))) {
                  include = false;
                }
              }
              if (include) {
                results.push(item);
              }
            }
            if (this.settings.approvalsTable.sortOption == "txorderasc") {
              results.sort((a, b) => {
                if (a.blockNumber == b.blockNumber) {
                  return a.logIndex - b.logIndex;
                } else {
                  return a.blockNumber - b.blockNumber;
                }
              });
            } else if (this.settings.approvalsTable.sortOption == "txorderdsc") {
              results.sort((a, b) => {
                if (a.blockNumber == b.blockNumber) {
                  return b.logIndex - a.logIndex;
                } else {
                  return b.blockNumber - a.blockNumber;
                }
              });
            } else if (this.settings.approvalsTable.sortOption == "ownerasc") {
              results.sort((a, b) => {
                return ('' + a.owner).localeCompare(b.owner);
              });
            } else if (this.settings.approvalsTable.sortOption == "ownerdsc") {
              results.sort((a, b) => {
                return ('' + b.owner).localeCompare(a.owner);
              });
            } else if (this.settings.approvalsTable.sortOption == "spenderasc") {
              results.sort((a, b) => {
                return ('' + a.spender).localeCompare(b.spender);
              });
            } else if (this.settings.approvalsTable.sortOption == "spenderdsc") {
              results.sort((a, b) => {
                return ('' + b.spender).localeCompare(a.spender);
              });
            } else if (this.settings.approvalsTable.sortOption == "tokensasc") {
              if (this.type == 20) {
                results.sort((a, b) => {
                  return a.tokens - b.tokens;
                });
              } else if (this.type == 721) {
                results.sort((a, b) => {
                  return a.tokenId - b.tokenId;
                });
              }
            } else if (this.settings.approvalsTable.sortOption == "tokensdsc") {
              if (this.type == 20) {
                results.sort((a, b) => {
                  return b.tokens - a.tokens;
                });
              } else if (this.type == 721) {
                results.sort((a, b) => {
                  return b.tokenId - a.tokenId;
                });
              }
            }
            return results;
          },
          pagedSortedFilteredApprovals() {
            return this.sortedFilteredApprovals.slice((this.settings.approvalsTable.currentPage - 1) * this.settings.approvalsTable.pageSize, this.settings.approvalsTable.currentPage * this.settings.approvalsTable.pageSize);
          },

          sortedFilteredApprovalForAlls() {
            // console.log(now() + " sortedFilteredApprovalForAlls");
            const results = [];
            const { regex, tokenIdRegex, blockTxHashRegex } = this.filterRegexes;
            for (const item of this.approvalForAlls) {
              let include = true;
              if (regex) {
                if (!(regex.test(item.owner) || regex.test(item.operator))) {
                  include = false;
                }
              }
              if (blockTxHashRegex) {
                if (!(blockTxHashRegex.test(item.txHash) || blockTxHashRegex.test(item.blockNumber))) {
                  include = false;
                }
              }
              if (include) {
                results.push(item);
              }
            }
            if (this.settings.approvalForAllsTable.sortOption == "txorderasc") {
              results.sort((a, b) => {
                if (a.blockNumber == b.blockNumber) {
                  return a.logIndex - b.logIndex;
                } else {
                  return a.blockNumber - b.blockNumber;
                }
              });
            } else if (this.settings.approvalForAllsTable.sortOption == "txorderdsc") {
              results.sort((a, b) => {
                if (a.blockNumber == b.blockNumber) {
                  return b.logIndex - a.logIndex;
                } else {
                  return b.blockNumber - a.blockNumber;
                }
              });
            } else if (this.settings.approvalForAllsTable.sortOption == "ownerasc") {
              results.sort((a, b) => {
                if (('' + a.owner).localeCompare(b.owner) == 0) {
                  if (a.blockNumber == b.blockNumber) {
                    return a.logIndex - b.logIndex;
                  } else {
                    return b.blockNumber - a.blockNumber;
                  }
                } else {
                  return ('' + a.owner).localeCompare(b.owner);
                }
              });
            } else if (this.settings.approvalForAllsTable.sortOption == "ownerdsc") {
              results.sort((a, b) => {
                if (('' + a.owner).localeCompare(b.owner) == 0) {
                  if (a.blockNumber == b.blockNumber) {
                    return a.logIndex - b.logIndex;
                  } else {
                    return b.blockNumber - a.blockNumber;
                  }
                } else {
                  return ('' + b.owner).localeCompare(a.owner);
                }
              });
            } else if (this.settings.approvalForAllsTable.sortOption == "operatorasc") {
              results.sort((a, b) => {
                if (('' + a.operator).localeCompare(b.operator) == 0) {
                  if (a.blockNumber == b.blockNumber) {
                    return a.logIndex - b.logIndex;
                  } else {
                    return b.blockNumber - a.blockNumber;
                  }
                } else {
                  return ('' + a.operator).localeCompare(b.operator);
                }
              });
            } else if (this.settings.approvalForAllsTable.sortOption == "operatordsc") {
              results.sort((a, b) => {
                if (('' + a.operator).localeCompare(b.operator) == 0) {
                  if (a.blockNumber == b.blockNumber) {
                    return a.logIndex - b.logIndex;
                  } else {
                    return b.blockNumber - a.blockNumber;
                  }
                } else {
                  return ('' + b.operator).localeCompare(a.operator);
                }
              });
            } else if (this.settings.approvalForAllsTable.sortOption == "approvedasc") {
              results.sort((a, b) => {
                if (a.approved == b.approved) {
                  if (a.blockNumber == b.blockNumber) {
                    return a.logIndex - b.logIndex;
                  } else {
                    return b.blockNumber - a.blockNumber;
                  }
                } else {
                  return (a.approved ? 1 : 0) - (b.approved ? 1 : 0);
                }
              });
            } else if (this.settings.approvalForAllsTable.sortOption == "approveddsc") {
              results.sort((a, b) => {
                if (a.approved == b.approved) {
                  if (a.blockNumber == b.blockNumber) {
                    return a.logIndex - b.logIndex;
                  } else {
                    return b.blockNumber - a.blockNumber;
                  }
                } else {
                  return (b.approved ? 1 : 0) - (a.approved ? 1 : 0);
                }
              });
            }
            return results;
          },
          pagedSortedFilteredApprovalForAlls() {
            return this.sortedFilteredApprovalForAlls.slice((this.settings.approvalForAllsTable.currentPage - 1) * this.settings.approvalForAllsTable.pageSize, this.settings.approvalForAllsTable.currentPage * this.settings.approvalForAllsTable.pageSize);
          },
        },

        // --- METHODS ---
        methods: {
          sampleContracts(type) {
            const results = [];
            for (const [ contract, contractData ] of Object.entries(this.network && this.network.contracts || {})) {
              if (contractData.type == type || type == "all") {
                results.push({ contract, type: contractData.type, name: contractData.name });
              }
            }
            return results;
          },
          nonFungibleViewerURL(contract, tokenId) {
            return this.nonFungibleViewer.replace(/\${contract}/, contract).replace(/\${tokenId}/, tokenId);
          },
          async viewNonFungible(type, contract, tokenId) {
            console.log(now() + " retrieveERC20 viewNonFungible - type: " + type + ", contract: " + contract + ", tokenId: " + tokenId);
            Vue.set(this.modalNonFungible, 'show', true);
            Vue.set(this.modalNonFungible, 'type', type);
            Vue.set(this.modalNonFungible, 'contract', contract);
            Vue.set(this.modalNonFungible, 'tokenId', tokenId);

            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const interface = new ethers.Contract(contract, type == 721 ? ERC721ABI : ERC1155ABI, provider);
            Vue.set(this.modalNonFungible, 'logs', []);
            this.modalNonFungible.logs.push({ log:now() + " ERC-" + type + " @ " + contract });
            let erc721Owner = null;
            let uriResult = null;
            if (type == 721) {
              erc721Owner = await interface.ownerOf(tokenId);
              this.modalNonFungible.logs.push({ log:now() + " erc721.ownerOf(" + tokenId + ") returned '" + erc721Owner + "'"});
            }
            if (type == 721) {
              uriResults = await interface.tokenURI(tokenId);
              this.modalNonFungible.logs.push({ log:now() + " erc721.tokenURI(" + tokenId + ") returned '" + uriResults + "'" });
            } else if (type == 1155) {
              uriResults = await interface.uri(tokenId);
              this.modalNonFungible.logs.push({ log:now() + " erc1155.uri(" + tokenId + ") returned '" + uriResults + "'" });
            }
            console.log("uriResults: " + uriResults);
            if (uriResults.substring(0, 12) == "ipfs://ipfs/") {
              uriResults = "https://ipfs.io/" + uriResults.substring(7)
              this.modalNonFungible.logs.push({ log:now() + " Updated URI to '" + uriResults + "'" });
            } else if (uriResults.substring(0, 7) == "ipfs://") {
              uriResults = "https://ipfs.io/ipfs/" + uriResults.substring(7);
              this.modalNonFungible.logs.push({ log:now() + " Updated URI to '" + uriResults + "'" });
            }
            if (type == 1155) {
              if (uriResults.indexOf("0x{id}") >= 0) {
                uriResults = uriResults.replace(/0x{id}/, tokenId);
                this.modalNonFungible.logs.push({ log:now() + " Updated URI to '" + uriResults + "'" });
              }
              if (uriResults.indexOf("{id}") >= 0) {
                uriResults = uriResults.replace(/{id}/, tokenId);
                this.modalNonFungible.logs.push({ log:now() + " Updated URI to '" + uriResults + "'" });
              }
            }
            try {
              this.modalNonFungible.logs.push({ log:now() + " Fetching '" + uriResults + "'" });
              try {
                const fileContent = await fetch(uriResults, { mode: 'cors', signal: AbortSignal.timeout(20000) }).then(response => response.json());
                this.modalNonFungible.logs.push({ log:now() + " Fetched '" + JSON.stringify(fileContent, null, 2) + "'" });
                console.log(now() + " retrieveERC20 viewNonFungible - fileContent: '" + JSON.stringify(fileContent, null, 2) + "'");
                this.modalNonFungible.name = fileContent && fileContent.name || null;
                this.modalNonFungible.logs.push({ log:now() + " name '" + this.modalNonFungible.name + "'" });
                this.modalNonFungible.description = fileContent && fileContent.description || null;
                this.modalNonFungible.logs.push({ log:now() + " description '" + this.modalNonFungible.description + "'" });
                this.modalNonFungible.image = fileContent && fileContent.image || null;
                this.modalNonFungible.logs.push({ log:now() + " image '" + this.modalNonFungible.image + "'" });
                if (this.modalNonFungible.image.substring(0, 12) == "ipfs://ipfs/") {
                  this.modalNonFungible.image = "https://ipfs.io/" + this.modalNonFungible.image.substring(7)
                  this.modalNonFungible.logs.push({ log:now() + " Updated image to '" + this.modalNonFungible.image + "'" });
                } else if (this.modalNonFungible.image.substring(0, 7) == "ipfs://") {
                  this.modalNonFungible.image = "https://ipfs.io/ipfs/" + this.modalNonFungible.image.substring(7);
                  this.modalNonFungible.logs.push({ log:now() + " Updated image to '" + this.modalNonFungible.image + "'" });
                }
                this.modalNonFungible.attributes = fileContent && fileContent.attributes || null;
                this.modalNonFungible.logs.push({ log:now() + " attributes '" + JSON.stringify(this.modalNonFungible.attributes, null, 2) + "'" });

              } catch (e) {
                this.modalNonFungible.logs.push({ log:now() + " ERROR Fetched failed" });
                console.log(now() + " ERROR - fetch: '" + e.message);
              }
            } catch (e) {
              console.log(now() + " viewNonFungible - ERROR: " + e.message);
            }
          },

          async retrieveEvents() {
            console.log(now() + " INFO retrieveEvents BEGIN - settings: " + JSON.stringify(this.settings));
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const erc20 = new ethers.Contract(this.settings.contract, ERC20ABI, provider);
            const erc165 = new ethers.Contract(this.settings.contract, ERC165ABI, provider);
            const erc721 = new ethers.Contract(this.settings.contract, ERC721ABI, provider);
            const erc1155 = new ethers.Contract(this.settings.contract, ERC1155ABI, provider);
            const block = await provider.getBlock("latest");
            const latestBlockNumber = parseInt(block.number);
            const timestamp = parseInt(block.timestamp);

            let [ supportsERC721, supportsERC1155 ] = [ false, false ];
            [ this.type, this.symbol, this.name, this.decimals, this.totalSupply, this.description ] = [ null, null, null, null, null, null ];
            try {
              supportsERC721 = await erc165.supportsInterface(ERC721_INTERFACE);
            } catch (e) {
            }
            if (supportsERC721) {
              this.type = 721;
              try {
                this.symbol = await erc721.symbol();
              } catch (e) {
              }
            } else {
              try {
                supportsERC1155 = await erc165.supportsInterface(ERC1155_INTERFACE);
                if (supportsERC1155) {
                  this.type = 1155;
                }
              } catch (e) {
              }
            }
            if (!this.type) {
              try {
                this.decimals = parseInt(await erc20.decimals());
              } catch (e) {
              }
              try {
                this.totalSupply = (await erc20.totalSupply()).toString();
              } catch (e) {
              }
              if (this.decimals != null && this.totalSupply) {
                this.type = 20;
                try {
                  this.symbol = await erc20.symbol();
                } catch (e) {
                }
                try {
                  this.name = await erc20.name();
                } catch (e) {
                }
              }
            }
            if (this.type == 20) {
              this.description = "ERC-20 " + this.symbol + " " + this.name + " " + this.decimals + " " + this.formatDecimals(this.totalSupply, this.decimals);
            } else if (this.type == 721) {
              this.description = "ERC-721 " + this.symbol;
            } else if (this.type == 1155) {
              this.description = "ERC-1155";
            } else {
              this.description = "Not a token contract";
            }
            console.log(now() + " retrieveEvents - this.description: " + this.description);

            // Retrieve Event Logs
            const events = [];
            const t = this; // async function has a new `this`, so use `t` to represent the original `this`
            async function getLogs(fromBlock, toBlock) {
              console.log(now() + " INFO retrieveEvents.getLogs - fromBlock: " + fromBlock + ", toBlock: " + toBlock);
              let split = false;
              try {
                const filter = {
                  address: t.settings.contract,
                  fromBlock,
                  toBlock,
                  topics: [
                    [
                      // ERC-20 event Transfer(address indexed from, address indexed to, uint tokens);
                      ethers.utils.id("Transfer(address,address,uint256)"),
                      // ERC-20 event Approval(address indexed owner, address indexed spender, uint tokens);
                      ethers.utils.id("Approval(address,address,uint256)"),
                      // ERC-721 event Transfer(address indexed from, address indexed to, uint256 indexed tokenId);
                      // ethers.utils.id("Transfer(address,address,uint256)"),
                      // ERC-721 event Approval(address indexed owner, address indexed approved, uint256 indexed tokenId);
                      // ethers.utils.id("Approval(address,address,uint256)"),
                      // ERC-721 event ApprovalForAll(address indexed owner, address indexed operator, bool approved);
                      ethers.utils.id("ApprovalForAll(address,address,bool)"),
                      // ERC-1155 event TransferSingle(address indexed operator, address indexed from, address indexed to, uint256 tokenId, uint256 value)
                      ethers.utils.id("TransferSingle(address,address,address,uint256,uint256)"),
                      // ERC-1155 event TransferBatch(address indexed operator, address indexed from, address indexed to, uint256[] tokenIds, uint256[] values);
                      ethers.utils.id("TransferBatch(address,address,address,uint256[],uint256[])"),
                      // ERC-1155 event ApprovalForAll(address indexed owner, address indexed operator, bool approved);
                      // ethers.utils.id("ApprovalForAll(address,address,bool)"),
                    ],
                    null,
                    null,
                  ],
                };
                const eventLogs = await provider.getLogs(filter);
                const records = parseEventLogs(eventLogs, this.type, this.chainId, latestBlockNumber);
                for (const record of records) {
                  events.push(record);
                }
                Vue.set(t, 'events', events);
              } catch (e) {
                split = true;
              }
              if (split) {
                const mid = parseInt((fromBlock + toBlock) / 2);
                await getLogs(fromBlock, mid);
                await getLogs(parseInt(mid) + 1, toBlock);
              }
            }
            const startBlock = 0;
            // const startBlock = latestBlockNumber - 10000;
            await getLogs(startBlock, latestBlockNumber);
            // console.log(now() + " INFO retrieveEvents END - events: " + JSON.stringify(events, null, 2));
            if (this.type == 20) {
              this.collateERC20();
            } else if (this.type == 721) {
              this.collateERC721();
            } else if (this.type == 1155) {
              this.collateERC1155();
            }
          },

          async collateERC20() {
            console.log(now() + " INFO collateERC20");
            const tokensCollator = {};
            const approvalsCollator = {};
            for (const event of this.events) {
              if (event.type == "Transfer") {
                if (!(event.from in tokensCollator)) {
                  tokensCollator[event.from] = {
                    blockNumber: event.blockNumber,
                    txIndex: event.txIndex,
                    txHash: event.txHash,
                    logIndex: event.logIndex,
                    tokens: event.from == ADDRESS0 ? "0" : ethers.BigNumber.from(0).sub(event.tokens).toString(),
                  };
                } else {
                  tokensCollator[event.from].blockNumber = event.blockNumber;
                  tokensCollator[event.from].txIndex = event.txIndex;
                  tokensCollator[event.from].txHash = event.txHash;
                  tokensCollator[event.from].logIndex = event.logIndex;
                  tokensCollator[event.from].blockNumber = event.blockNumber;
                  if (event.from != ADDRESS0) {
                    tokensCollator[event.from].tokens = ethers.BigNumber.from(tokensCollator[event.from].tokens).sub(event.tokens).toString();
                  }
                }
                if (!(event.to in tokensCollator)) {
                  tokensCollator[event.to] = {
                    blockNumber: event.blockNumber,
                    txIndex: event.txIndex,
                    txHash: event.txHash,
                    logIndex: event.logIndex,
                    tokens: event.tokens,
                  };
                } else {
                  tokensCollator[event.to].blockNumber = event.blockNumber;
                  tokensCollator[event.to].txIndex = event.txIndex;
                  tokensCollator[event.to].txHash = event.txHash;
                  tokensCollator[event.to].logIndex = event.logIndex;
                  tokensCollator[event.to].tokens = ethers.BigNumber.from(tokensCollator[event.to].tokens).add(event.tokens).toString();
                }
              } else if (event.type == "Approval") {
                if (!(event.owner in approvalsCollator)) {
                  approvalsCollator[event.owner] = {};
                }
                approvalsCollator[event.owner][event.spender] = {
                  blockNumber: event.blockNumber,
                  txIndex: event.txIndex,
                  txHash: event.txHash,
                  logIndex: event.logIndex,
                  tokens: event.tokens,
                };
              }
            }
            // console.log(now() + " INFO collateERC20 - tokensCollator: " + JSON.stringify(tokensCollator, null, 2));
            // console.log(now() + " INFO collateERC20 - approvalsCollator: " + JSON.stringify(approvalsCollator, null, 2));
            const tokens = [];
            for (const [ owner, balance ] of Object.entries(tokensCollator)) {
              tokens.push({ owner, ...balance });
            }
            Vue.set(this, 'tokens', tokens);
            const approvals = [];
            for (const [ owner, spenders ] of Object.entries(approvalsCollator)) {
              for (const [spender, tokens] of Object.entries(spenders)) {
                approvals.push({ owner, spender, ...tokens });
              }
            }
            Vue.set(this, 'approvals', approvals);
            Vue.set(this, 'approvalForAlls', []);
          },
          async collateERC721() {
            console.log(now() + " INFO collateERC721");
            const tokensCollator = {};
            const approvalForAllsCollator = {};
            const approvalsCollator = {};
            for (const event of this.events) {
              if (event.type == "Transfer") {
                tokensCollator[event.tokenId] = {
                  blockNumber: event.blockNumber,
                  txIndex: event.txIndex,
                  txHash: event.txHash,
                  logIndex: event.logIndex,
                  owner: event.to,
                };
              } else if (event.type == "Approval") {
                approvalsCollator[event.tokenId] = {
                  blockNumber: event.blockNumber,
                  txIndex: event.txIndex,
                  txHash: event.txHash,
                  logIndex: event.logIndex,
                  owner: event.owner,
                  spender: event.spender,
                };
              } else if (event.type == "ApprovalForAll") {
                if (!(event.owner in approvalForAllsCollator)) {
                  approvalForAllsCollator[event.owner] = {};
                }
                approvalForAllsCollator[event.owner][event.operator] = {
                  blockNumber: event.blockNumber,
                  txIndex: event.txIndex,
                  txHash: event.txHash,
                  logIndex: event.logIndex,
                  approved: event.approved,
                };
              } else {
                console.log(now() + " INFO collateERC721 - ELSE event: " + JSON.stringify(event));
              }
            }
            // console.log(now() + " INFO collateERC721 - tokensCollator: " + JSON.stringify(tokensCollator, null, 2));
            // console.log(now() + " INFO collateERC721 - approvalForAllsCollator: " + JSON.stringify(approvalForAllsCollator, null, 2));
            // console.log(now() + " INFO collateERC721 - approvalsCollator: " + JSON.stringify(approvalsCollator, null, 2));
            const tokens = [];
            for (const [ tokenId, tokenData ] of Object.entries(tokensCollator)) {
              tokens.push({ tokenId, ...tokenData });
            }
            Vue.set(this, 'tokens', tokens);
            const approvalForAlls = [];
            for (const [ owner, ownerData ] of Object.entries(approvalForAllsCollator)) {
              for (const [ operator, operatorData ] of Object.entries(ownerData)) {
                approvalForAlls.push({ owner, operator, ...operatorData });
              }
            }
            Vue.set(this, 'approvalForAlls', approvalForAlls);
            const approvals = [];
            for (const [ tokenId, tokenData ] of Object.entries(approvalsCollator)) {
              approvals.push({ tokenId, ...tokenData });
            }
            Vue.set(this, 'approvals', approvals);
          },
          async collateERC1155() {
            console.log(now() + " INFO collateERC1155");
            const tokensCollator = {};
            const approvalForAllsCollator = {};
            for (const event of this.events) {
              if (event.type == "TransferSingle") {
                if (!(event.tokenId in tokensCollator)) {
                  tokensCollator[event.tokenId] = {};
                }
                if (!(event.from in tokensCollator[event.tokenId])) {
                  tokensCollator[event.tokenId][event.from] = {
                    blockNumber: event.blockNumber,
                    txIndex: event.txIndex,
                    txHash: event.txHash,
                    logIndex: event.logIndex,
                    value: event.from == ADDRESS0 ? "0" : ethers.BigNumber.from(0).sub(event.value).toString(),
                  };
                } else {
                  tokensCollator[event.tokenId][event.from].blockNumber = event.blockNumber;
                  tokensCollator[event.tokenId][event.from].txIndex = event.txIndex;
                  tokensCollator[event.tokenId][event.from].txHash = event.txHash;
                  tokensCollator[event.tokenId][event.from].logIndex = event.logIndex;
                  if (event.from != ADDRESS0) {
                    tokensCollator[event.tokenId][event.from].value = ethers.BigNumber.from(tokensCollator[event.tokenId][event.from].value).add(event.value).toString();
                  }
                }
                if (!(event.to in tokensCollator[event.tokenId])) {
                  tokensCollator[event.tokenId][event.to] = {
                    blockNumber: event.blockNumber,
                    txIndex: event.txIndex,
                    txHash: event.txHash,
                    logIndex: event.logIndex,
                    value: event.value,
                  };
                } else {
                  tokensCollator[event.tokenId][event.to].blockNumber = event.blockNumber;
                  tokensCollator[event.tokenId][event.to].txIndex = event.txIndex;
                  tokensCollator[event.tokenId][event.to].txHash = event.txHash;
                  tokensCollator[event.tokenId][event.to].logIndex = event.logIndex;
                  tokensCollator[event.tokenId][event.to].value = ethers.BigNumber.from(tokensCollator[event.tokenId][event.to].value).add(event.value).toString();
                }
              } else if (event.type == "TransferBatch") {
                for (let i = 0; i < event.tokenIds.length; i++) {
                  if (!(event.tokenIds[i] in tokensCollator)) {
                    tokensCollator[event.tokenIds[i]] = {};
                  }
                  if (!(event.from in tokensCollator[event.tokenIds[i]])) {
                    tokensCollator[event.tokenIds[i]][event.from] = {
                      blockNumber: event.blockNumber,
                      txIndex: event.txIndex,
                      txHash: event.txHash,
                      logIndex: event.logIndex,
                      value: event.from == ADDRESS0 ? "0" : ethers.BigNumber.from(0).sub(event.values[i]).toString(),
                    };
                  } else {
                    tokensCollator[event.tokenIds[i]][event.from].blockNumber = event.blockNumber;
                    tokensCollator[event.tokenIds[i]][event.from].txIndex = event.txIndex;
                    tokensCollator[event.tokenIds[i]][event.from].txHash = event.txHash;
                    tokensCollator[event.tokenIds[i]][event.from].logIndex = event.logIndex;
                    if (event.from != ADDRESS0) {
                      tokensCollator[event.tokenIds[i]][event.from].value = ethers.BigNumber.from(tokensCollator[event.tokenIds[i]][event.from].value).add(event.values[i]).toString();
                    }
                  }

                }
              } else if (event.type == "ApprovalForAll") {
                if (!(event.owner in approvalForAllsCollator)) {
                  approvalForAllsCollator[event.owner] = {};
                }
                approvalForAllsCollator[event.owner][event.operator] = {
                  blockNumber: event.blockNumber,
                  txIndex: event.txIndex,
                  txHash: event.txHash,
                  logIndex: event.logIndex,
                  approved: event.approved,
                };
              } else {
                console.log(now() + " INFO collateERC1155 - ELSE event: " + JSON.stringify(event));
              }
            }
            // console.log(now() + " INFO collateERC1155 - tokensCollator: " + JSON.stringify(tokensCollator, null, 2));
            // console.log(now() + " INFO collateERC1155 - approvalForAllsCollator: " + JSON.stringify(approvalForAllsCollator, null, 2));
            const tokens = [];
            for (const [ tokenId, tokenData ] of Object.entries(tokensCollator)) {
              for (const [ owner, ownerData ] of Object.entries(tokenData)) {
                tokens.push({ tokenId, owner, ...ownerData });
              }
            }
            Vue.set(this, 'tokens', tokens);
            const approvalForAlls = [];
            for (const [ owner, ownerData ] of Object.entries(approvalForAllsCollator)) {
              for (const [ operator, operatorData ] of Object.entries(ownerData)) {
                approvalForAlls.push({ owner, operator, ...operatorData });
              }
            }
            Vue.set(this, 'approvalForAlls', approvalForAlls);
            Vue.set(this, 'approvals', []);
          },

          async retrieveERC20BalanceOf() {
            console.log(now() + " retrieveERC20BalanceOf BEGIN - settings.erc20: " + JSON.stringify(this.settings.erc20, null, 2));
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const contract = new ethers.Contract(this.settings.erc20.contract, ERC20ABI, provider);
            const block = await provider.getBlock("latest");
            const decimals = await contract.decimals();
            Vue.set(this.erc20, 'decimals', decimals.toString());
            const balanceOf = await contract.balanceOf(this.settings.erc20.balanceOf.owner);
            Vue.set(this.erc20, 'balanceOf', balanceOf);
            // console.log(now() + " retrieveERC20BalanceOf - erc20.balanceOf: " + balanceOf);
          },

          async retrieveERC20Allowance() {
            console.log(now() + " retrieveERC20Allowance BEGIN - settings.erc20: " + JSON.stringify(this.settings.erc20, null, 2));
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const contract = new ethers.Contract(this.settings.erc20.contract, ERC20ABI, provider);
            const block = await provider.getBlock("latest");
            const decimals = await contract.decimals();
            Vue.set(this.erc20, 'decimals', decimals.toString());
            const allowance = await contract.allowance(this.settings.erc20.allowance.owner, this.settings.erc20.allowance.spender);
            Vue.set(this.erc20, 'allowance', allowance);
            // console.log(now() + " retrieveERC20Allowance - erc20.allowance: " + allowance);
          },

          async retrieveTimestamps(blockNumbers) {
            console.log(now() + " retrieveTimestamps BEGIN - blockNumbers: " + JSON.stringify(blockNumbers, null, 2));
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            if (!(this.chainId in this.timestamps)) {
              Vue.set(this.timestamps, this.chainId, {});
            }
            for (const blockNumber of blockNumbers) {
              if (!(blockNumber in this.timestamps[this.chainId])) {
                try {
                  const block = await provider.getBlock(blockNumber);
                  Vue.set(this.timestamps[this.chainId], blockNumber, parseInt(block.timestamp));
                } catch (e) {
                  console.log(now() + " retrieveTimestamps ERROR: " + e.message);
                }
              }
            }
            localStorage.tokenExplorerTimestamps = JSON.stringify(this.timestamps);
            // console.log(now() + " retrieveTimestamps END - timestamps: " + JSON.stringify(this.timestamps, null, 2));
          },

          async transferERC20() {
            console.log(now() + " transferERC20 - settings.erc20: " + JSON.stringify(this.settings.erc20));
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const signer = provider.getSigner();
            const contract = new ethers.Contract(this.settings.erc20.contract, ERC20ABI, provider);
            const contractWithSigner = contract.connect(provider.getSigner());
            const decimals = await contract.decimals();
            try {
              const tx = await contractWithSigner.transfer(this.settings.erc20.transfer.to, ethers.utils.parseUnits(this.settings.erc20.transfer.tokens, decimals));
              console.log(now() + " transferERC20 - tx: " + JSON.stringify(tx));
              Vue.set(this.erc20.transferTx, 'txHash', tx && tx.hash || null);
              Vue.set(this.erc20.transferTx, 'result', JSON.stringify(tx, null, 2));
            } catch (e) {
              console.log(now() + " transferERC20 - ERROR: " + JSON.stringify(e));
              Vue.set(this.erc20.transferTx, 'txHash', null);
              Vue.set(this.erc20.transferTx, 'result', JSON.stringify(e, null, 2));
            }
            console.log(now() + " transferERC20 END - erc20.transferTx: " + JSON.stringify(this.erc20.transferTx));
          },

          async approveERC20() {
            console.log(now() + " approveERC20 - settings.erc20: " + JSON.stringify(this.settings.erc20));
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const signer = provider.getSigner();
            const contract = new ethers.Contract(this.settings.erc20.contract, ERC20ABI, provider);
            const contractWithSigner = contract.connect(provider.getSigner());
            const decimals = await contract.decimals();
            try {
              const tx = await contractWithSigner.approve(this.settings.erc20.approve.spender, ethers.utils.parseUnits(this.settings.erc20.approve.tokens, decimals));
              console.log(now() + " approveERC20 - tx: " + JSON.stringify(tx));
              Vue.set(this.erc20.approveTx, 'txHash', tx && tx.hash || null);
              Vue.set(this.erc20.approveTx, 'result', JSON.stringify(tx, null, 2));
            } catch (e) {
              console.log(now() + " approveERC20 - ERROR: " + JSON.stringify(e));
              Vue.set(this.erc20.approveTx, 'txHash', null);
              Vue.set(this.erc20.approveTx, 'result', JSON.stringify(e, null, 2));
            }
            console.log(now() + " approveERC20 END - erc20.approveTx: " + JSON.stringify(this.erc20.approveTxHash));
          },

          async transferFromERC20() {
            console.log(now() + " transferFromERC20 - settings.erc20: " + JSON.stringify(this.settings.erc20));
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const signer = provider.getSigner();
            const contract = new ethers.Contract(this.settings.erc20.contract, ERC20ABI, provider);
            const contractWithSigner = contract.connect(provider.getSigner());
            const decimals = await contract.decimals();
            try {
              const tx = await contractWithSigner.transferFrom(this.settings.erc20.transferFrom.from, this.settings.erc20.transferFrom.to, ethers.utils.parseUnits(this.settings.erc20.transferFrom.tokens, decimals));
              console.log(now() + " transferFromERC20 - tx: " + JSON.stringify(tx));
              Vue.set(this.erc20.transferFromTx, 'txHash', tx && tx.hash || null);
              Vue.set(this.erc20.transferFromTx, 'result', JSON.stringify(tx, null, 2));
            } catch (e) {
              console.log(now() + " transferFromERC20 - ERROR: " + JSON.stringify(e));
              Vue.set(this.erc20.transferFromTx, 'txHash', null);
              Vue.set(this.erc20.transferFromTx, 'result', JSON.stringify(e, null, 2));
            }
            console.log(now() + " transferFromERC20 END - erc20.transferFromTx: " + JSON.stringify(this.erc20.transferFromTx));
          },

          validAddress(a) {
            if (a) {
              try {
                const address = ethers.utils.getAddress(a);
                return true;
              } catch (e) {
              }
            }
            return false;
          },
          validNumber(n) {
            return n && !isNaN(n) || false;
          },
          saveSettings() {
            // console.log(now() + " saveSettings: " + JSON.stringify(this.settings, null, 2));
            localStorage.tokenExplorerSettings = JSON.stringify(this.settings);
          },
          async processNewBlock(blockNumber) {
            console.log(now() + " processNewBlock[" + this.chainId + "] #" + this.formatNumber(blockNumber) + ", latest #" + this.formatNumber(this.blockNumber) + " @ " + moment.unix(this.timestamp).format("YYYY-MM-DD HH:mm:ss") + " " + moment.unix(this.timestamp).fromNow());
          },
          formatETH(e, precision = 9) {
            try {
              if (precision == 0) {
                return e ? ethers.utils.formatEther(e) : null;
              } else {
                return e ? parseFloat(ethers.utils.formatEther(e)).toFixed(precision) : null;
              }
            } catch (err) {
            }
            return e.toFixed(precision);
          },
          formatNumber(e) {
            return e != null ? e.toString().replace(/(?<!(\.\d*|^.{0}))(?=(\d{3})+(?!\d))/g, ',') : null;
          },
          formatDecimals(e, decimals = 0) {
            return e != null ? ethers.utils.formatUnits(e, decimals).replace(/(?<!(\.\d*|^.{0}))(?=(\d{3})+(?!\d))/g, ',') : null;
          },
          formatTimestamp(ts) {
            if (ts != null) {
              if (this.settings.reportingDateTime == 1) {
                return moment.unix(ts).utc().format("YYYY-MM-DD HH:mm:ss");
              } else {
                return moment.unix(ts).format("YYYY-MM-DD HH:mm:ss");
              }
            }
            return null;
          },
          formatTimeDiff(unixtime) {
            if (!unixtime) {
              return "";
            } else {
              return moment.unix(unixtime).fromNow();
            }
          },
          copyToClipboard(str) {
            navigator.clipboard.writeText(str);
          },
          async connectToWeb3() {
            if (!window.ethereum) {
              this.connected = false;
            } else {
              try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                this.connected = window.ethereum.isConnected();
              } catch (e) {
                console.log("window.ethereum.request error: " + e.message);
                this.connected = false;
              }
            }
            if (!this.connected) {
              alert("Please use the https://metamask.io addon with Firefox, Chromium, Opera or Chrome, or any other other web3 browser, for web3 data retrieval. And refresh!");
            } else {
              const t = this;
              function handleChainChanged(_chainId) {
                t.chainId = parseInt(_chainId);
                console.log(now() + " connectToWeb3 - handleChainChanged - this.chainId: " + t.chainId);
                // alert('Ethereum chain has changed - reloading this page.')
                // window.location.reload();
              }
              window.ethereum.on('chainChanged', handleChainChanged);
              const provider = new ethers.providers.Web3Provider(window.ethereum);
              async function handleAccountsChanged(accounts) {
                const signer = provider.getSigner();
                t.coinbase = await signer.getAddress();
                console.log(now() + " connectToWeb3 - handleAccountsChanged: " + t.coinbase);
              }
              window.ethereum.on('accountsChanged', handleAccountsChanged);
              async function handleNewBlock(blockNumber) {
                if (!t.blockNumber || blockNumber > t.blockNumber) {
                  const block = await provider.getBlock("latest");
                  t.blockNumber = block.number;
                  t.timestamp = block.timestamp;
                  await t.processNewBlock(blockNumber);
                }
              }
              provider.on("block", handleNewBlock);
              const signer = provider.getSigner();
              this.coinbase = await signer.getAddress();
              const network = await provider.getNetwork();
              this.chainId = network.chainId;
              console.log(now() + " connectToWeb3[" + this.chainId + "]");
            }
          },
        },

        // --- MOUNTED ---
        mounted() {
          (async() => {
            await this.connectToWeb3();
          })();
          if ('tokenExplorerChainId' in localStorage) {
            this.chainId = localStorage.tokenExplorerChainId;
          }
          if ('tokenExplorerCoinbase' in localStorage) {
            this.coinbase = localStorage.tokenExplorerCoinbase;
          }
          if ('tokenExplorerTimestamps' in localStorage) {
            this.timestamps = JSON.parse(localStorage.tokenExplorerTimestamps);
          }
          if ('tokenExplorerSettings' in localStorage) {
            const tempSettings = JSON.parse(localStorage.tokenExplorerSettings);
            if ('version' in tempSettings && tempSettings.version == this.settings.version) {
              this.settings = tempSettings;
              this.settings.eventsTable.currentPage = 1;
              this.settings.tokensTable.currentPage = 1;
              this.settings.approvalsTable.currentPage = 1;
              this.settings.approvalForAllsTable.currentPage = 1;
            }
          }
        },
      })
    </script>
  </body>
</html>
